<script type="module">
  import { injectLayout } from './js/include.js';
  import { getProjectById } from './js/api.js';
  import { storage } from './js/firebase.js';
  import { ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

  injectLayout({ active:'project' });

  const $detail = document.getElementById('project-detail');
  const fmt = n => Number(n||0).toLocaleString('ko-KR');

  /* ---------------- 이미지 후보 수집 + URL 변환 (강화판) ---------------- */

  // 문서 내에서 있을 법한 필드들을 전부 후보로 모음
  function candidatesOf(p){
    const out = [];
    const push = v => { if (typeof v === 'string' && v.trim()) out.push(v.trim()); };

    // 단일 문자열 필드들(이름이 제각각일 수 있음)
    [
      'representativeImageUrl','representativeImage','representImg',
      'coverUrl','coverURL','cover','mainImageUrl','mainImage',
      'thumbnailUrl','thumbnail','thumbUrl','thumbnailURL',
      'image','imageUrl','imageURL','photo','photoUrl','photoURL'
    ].forEach(k => push(p[k]));

    // 배열 필드들(문자열 또는 {url|downloadUrl|path})
    ['galleryUrls','images','photos','pictures','media','attachments','files']
    .forEach(k => {
      const arr = p[k];
      if (Array.isArray(arr)) {
        arr.forEach(it => {
          if (typeof it === 'string') push(it);
          else if (it && (it.url || it.downloadUrl || it.path)) push(it.url || it.downloadUrl || it.path);
        });
      }
    });

    return out;
  }

  // 경로/이상한 URL → 표시 가능한 http(s) URL로 변환
  async function toHttpUrl(raw) {
    if (!raw) return null;
    let v = (typeof raw === 'string') ? raw.trim() : String(raw);

    // 이미 표시 가능한 스킴은 우선 통과
    if (/^(https?:|data:|blob:)/i.test(v)) {
      // 예외: https://<bucket>.firebasestorage.app/<path> 는 유효하지 않을 수 있으니 교정 시도
      const m = v.match(/^https?:\/\/([^/]+)\.firebasestorage\.app\/(.+)$/i);
      if (m) {
        const gs = `gs://${m[1]}.appspot.com/${decodeURIComponent(m[2].replace(/%2F/gi,'/'))}`;
        try { return await getDownloadURL(ref(storage, gs)); } catch { /* fallthrough */ }
      }
      return v;
    }

    // 선행 슬래시 제거(/covers/.. → covers/..)
    if (v.startsWith('/')) v = v.slice(1);

    // gs:// …firebasestorage.app  → gs:// …appspot.com 로 교정
    if (/^gs:\/\//i.test(v)) {
      v = v.replace(/gs:\/\/([^/]+)\.firebasestorage\.app(\/|$)/i, 'gs://$1.appspot.com$2');
    }

    // URL-인코딩된 경로(%2F 등) 정리
    try { v = decodeURIComponent(v); } catch {}

    try {
      return await getDownloadURL(ref(storage, v)); // 'covers/..' 또는 교정된 'gs://..'
    } catch (e) {
      console.warn('[project] getDownloadURL 실패:', v, e?.message || e);
      return null;
    }
  }

  // 대표 이미지 1장만 필요할 때
  async function coverUrlOf(p) {
    const cands = candidatesOf(p);
    for (const c of cands) {
      const u = await toHttpUrl(c);
      if (u) return u;
    }
    return 'img/placeholder.svg';
  }

  // 갤러리 전체 이미지(중복 제거)
  async function galleryHttpUrls(p){
    const cands = candidatesOf(p);
    const urls  = await Promise.all(cands.map(toHttpUrl));
    const uniq = [];
    const seen = new Set();
    for (const u of urls) {
      if (!u) continue;
      if (seen.has(u)) continue;
      seen.add(u);
      uniq.push(u);
    }
    return uniq.length ? uniq : ['img/placeholder.svg'];
  }
  /* ---------------- /이미지 변환 끝 ---------------- */

  // UI 렌더
  function getId(){ return new URLSearchParams(location.search).get("id"); }

  function renderSlider(imgs){
    if(!imgs || !imgs.length) return '';
    if(imgs.length === 1){
      return `<img class="kv" src="${imgs[0]}" alt="project image"/>`;
    }
    return `
      <div class="slider">
        ${imgs.map((u,i)=>`<img src="${u}" class="${i===0?'active':''}" alt="gallery ${i+1}"/>`).join('')}
        <div class="slider-nav">
          <button id="prevBtn">◀</button>
          <button id="nextBtn">▶</button>
        </div>
      </div>
    `;
  }

  async function render(){
    const id = getId();
    if(!id){
      $detail.innerHTML = '<div class="muted">잘못된 접근입니다.</div>';
      return;
    }
    try{
      const p = await getProjectById(id);
      if(!p){
        $detail.innerHTML = '<div class="muted">존재하지 않는 프로젝트입니다.</div>';
        return;
      }

      const imgs = await galleryHttpUrls(p);

      $detail.innerHTML = `
        <h1>${p.name ?? '(이름 없음)'}</h1>
        <div class="muted">구조자: ${p.rescuerName ?? ''}</div>

        ${renderSlider(imgs)}

        <p>${p.description ?? ''}</p>
        <p class="muted">목표 금액: ${fmt(p.goalAmount)}원</p>
        <p class="muted">구조자 부담금: ${fmt(p.rescuerContribution)}원</p>
        <p class="muted">지지자 수: ${fmt(p.supportersCount)}</p>
        ${p.registrantKakaoId ? `<a href="https://open.kakao.com/o/${p.registrantKakaoId}" target="_blank" class="btn kakao">카카오톡으로 참여하기</a>` : ''}
      `;

      // 슬라이더 동작
      const sliderImgs = $detail.querySelectorAll('.slider img');
      if(sliderImgs.length){
        let idx = 0;
        const prev = document.getElementById('prevBtn');
        const next = document.getElementById('nextBtn');
        const show = (i) => sliderImgs.forEach((img,j)=>img.classList.toggle('active', j===i));
        prev?.addEventListener('click', ()=>{ idx = (idx-1+sliderImgs.length)%sliderImgs.length; show(idx); });
        next?.addEventListener('click', ()=>{ idx = (idx+1)%sliderImgs.length; show(idx); });
      }
    }catch(e){
      console.error(e);
      $detail.innerHTML = '<div class="muted">프로젝트를 불러오지 못했습니다.</div>';
    }
  }

  render();
</script>
