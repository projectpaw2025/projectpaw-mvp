<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>프로젝트 상세 - Project.PAW</title>
  <link rel="stylesheet" href="common.css"/>
  <link rel="stylesheet" href="app.min.css"/>
  <link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/variable/woff2/SUIT-Variable.css" rel="stylesheet"/>
  <style>
    :root{--ink:#111;--sub:#666;--line:#e7e7e7;--accent:#E87722;--bg:#f8f8f8}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:'SUIT Variable',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1040px;margin:0 auto;padding:20px 16px}

    /* 레이아웃 */
    .grid{display:grid;gap:20px}
    @media(min-width:992px){.grid{grid-template-columns:1.05fr .95fr}}

    /* 패널 공통 */
    .panel{background:#fff;border:1px solid var(--line);border-radius:14px;padding:18px}
    .panel h2{margin:0 0 10px;font-size:1.1rem;font-weight:900;color:var(--accent)}
    .muted{color:var(--sub)}

    /* 좌측: 미디어 */
    .media{border-radius:12px;overflow:hidden;border:1px solid var(--line);background:#fff}
    .media img{display:block;width:100%;height:56vh;min-height:280px;max-height:680px;object-fit:cover}

    /* 진행 블록(사진 아래) */
    .progress-lite{display:flex;gap:16px;flex-wrap:wrap}
    .kv{flex:1 1 160px;background:#fff;border:1px solid var(--line);border-radius:10px;padding:12px}
    .kv .k{font-size:.9rem;color:var(--sub)}
    .kv .v{margin-top:4px;font-weight:900}
    .kv .v.big{font-size:1.3rem}

    /* 우측: 타이틀/배지/요약/스토리 */
    .title{margin:0 0 6px;font-size:1.6rem;font-weight:900}
    .meta-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-weight:800;font-size:.85rem;background:#fff}
    .summary{margin:6px 0 12px;color:var(--ink)}
    .story{color:var(--ink);line-height:1.7}
    .story .clip{max-height:240px;overflow:hidden;position:relative}
    .story .more{margin-top:10px;color:var(--accent);font-weight:900;cursor:pointer}

    /* 영수증 그리드 */
    .receipts{display:flex;flex-wrap:wrap;gap:8px}
    .receipts a{display:block;border:1px solid var(--line);border-radius:8px;overflow:hidden}
    .receipts img{display:block;width:110px;height:110px;object-fit:cover}

    /* CTA */
    .cta{display:flex;gap:10px;margin-top:16px}
    .btn{display:inline-block;text-decoration:none;text-align:center;border-radius:10px;padding:12px 14px;font-weight:900}
    .btn-primary{background:#FEE500;color:#111}
    .btn-secondary{background:#6b7280;color:#fff}
    @media(max-width:600px){.cta{flex-direction:column}}
  </style>
</head>
<body>
  <div data-include="header"></div>

  <main class="wrap">
    <div id="project-detail"><div class="muted">불러오는 중...</div></div>
  </main>

  <div data-include="footer"></div>

  <script type="module">
    import { injectLayout } from './js/include.js';
    import { getProjectById } from './js/api.js';
    import { storage } from './js/firebase.js';
    import { ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

    injectLayout({ active:'project' });
    const $detail=document.getElementById('project-detail');
    const fmt=n=>Number(n||0).toLocaleString('ko-KR');

    /* 이미지/영수증 URL 수집 */
    function imgCands(p){
      const out=[];const push=v=>{if(typeof v==='string'&&v.trim())out.push(v.trim());};
      ['representativeImageUrl','coverUrl','mainImageUrl','thumbnailUrl','image'].forEach(k=>push(p[k]));
      ['galleryUrls','images','photos','files'].forEach(k=>{
        const arr=p[k];if(Array.isArray(arr))arr.forEach(it=>{
          if(typeof it==='string') push(it);
          else if(it&&(it.url||it.path)) push(it.url||it.path);
        });
      });
      return out;
    }
    function receiptCands(p){
      const out=[]; const push=v=>{if(typeof v==='string'&&v.trim())out.push(v.trim());};
      ['receiptUrls','receipts'].forEach(k=>{
        const v=p[k];
        if(Array.isArray(v)) v.forEach(it=>{
          if(typeof it==='string') push(it);
          else if(it&&(it.url||it.path)) push(it.url||it.path);
        });
      });
      return out;
    }
    async function toHttp(raw){
      if(!raw) return null;
      let v=String(raw).trim();
      if(/^(https?:|data:|blob:)/i.test(v)) return v;
      if(v.startsWith('/')) v=v.slice(1);
      try{return await getDownloadURL(ref(storage,v));}catch{return null;}
    }
    async function galleryUrls(p){
      const urls=await Promise.all(imgCands(p).map(toHttp));
      const uniq=[],seen=new Set(); for(const u of urls){if(u&&!seen.has(u)){seen.add(u);uniq.push(u);}}
      return uniq.length?uniq:['img/placeholder.svg'];
    }
    async function receiptUrls(p){
      const urls=await Promise.all(receiptCands(p).map(toHttp));
      const uniq=[],seen=new Set(); for(const u of urls){if(u&&!seen.has(u)){seen.add(u);uniq.push(u);}}
      return uniq; // 없으면 빈 배열
    }

    function getId(){return new URLSearchParams(location.search).get('id');}
    function fmtDesc(text){if(!text) return '';return text.replace(/\n/g,'<br/>');}

    function whyBlock(){
      return `
        <div class="panel">
          <h2>왜 Project.PAW인가?</h2>
          <p class="muted" style="line-height:1.7">
            Project.PAW는 <b>이미 구조자가 먼저 책임</b>진 사례만 공개합니다.<br/>
            <b>영수증 증빙</b> 가능한 케이스만 등록해 도덕적 해이를 막습니다.<br/>
            우리는 <b>개인↔개인 직접 연결</b>을 지향합니다. 돈보다 연결을 중시합니다.<br/>
            구조자에 대한 <b>감사의 마음</b>이 더 큰 구조의 파이를 키웁니다.
          </p>
        </div>`;
    }
    function betaBlock(){
      return `
        <div class="panel">
          <h2>Beta 안내</h2>
          <p class="muted" style="line-height:1.7">
            ⚠️ 현재 Project.PAW는 <b>실험 단계</b>입니다.<br/>
            후원은 카카오톡 단톡방을 통해 이루어지며, 관리자가 수동으로 모금/참여 수치를 업데이트합니다.<br/>
            정식 서비스에서는 PG 결제를 통한 자동화·투명 시스템이 제공될 예정입니다.
          </p>
        </div>`;
    }

    async function render(){
      const id=getId();
      if(!id){$detail.innerHTML='<div class="muted">잘못된 접근입니다.</div>';return;}
      try{
        const p=await getProjectById(id);
        if(!p){$detail.innerHTML='<div class="muted">존재하지 않는 프로젝트입니다.</div>';return;}

        const imgs=await galleryUrls(p);
        const receipts=await receiptUrls(p);

        const goal=Number(p.goalAmount||0);
        const current=Number(p.currentAmount||0);
        const remaining=Math.max(goal-current,0);

        const caseType = p.caseType || (p.adminApproved?'ongoing':'upcoming');
        const stateBadge = caseType==='completed'?'완료·인증' : (caseType==='upcoming'?'사전예고' : (p.adminApproved?'진행중':'대기중'));

        $detail.innerHTML = `
          <div class="grid">
            <!-- LEFT -->
            <div>
              <div class="media panel" style="padding:0">
                <img src="${imgs[0]}" alt="project image"/>
              </div>

              <!-- 진행 블록(사진 아래) -->
              <div class="panel">
                <h2>진행</h2>
                <div class="progress-lite">
                  ${goal?`
                  <div class="kv">
                    <div class="k">목표 금액</div>
                    <div class="v">₩${fmt(goal)}</div>
                  </div>`:''}
                  <div class="kv">
                    <div class="k">현재 모금</div>
                    <div class="v">₩${fmt(current)}</div>
                  </div>
                  ${goal?`
                  <div class="kv">
                    <div class="k">남은 금액</div>
                    <div class="v big">₩${fmt(remaining)}</div>
                  </div>`:''}
                  <div class="kv">
                    <div class="k">연결된 마음</div>
                    <div class="v">${fmt(p.supporterCount||0)}명</div>
                  </div>
                </div>
              </div>

              <!-- Why & Beta (사진 아래) -->
              ${whyBlock()}
              ${betaBlock()}

              <!-- 영수증 (있을 때만) -->
              ${Array.isArray(receipts)&&receipts.length?`
                <div class="panel">
                  <h2>📎 영수증·진료내역</h2>
                  <div class="receipts">
                    ${receipts.map(u=>`<a href="${u}" target="_blank" rel="noopener"><img src="${u}" alt="receipt"/></a>`).join('')}
                  </div>
                  <p class="muted" style="margin-top:8px;font-size:.9rem">※ 구조자가 직접 결제한 내역을 증빙으로 공개합니다.</p>
                </div>
              `:''}
            </div>

            <!-- RIGHT -->
            <div>
              <div class="panel">
                <div class="meta-row">
                  ${p.problemType?`<span class="badge">${p.problemType}</span>`:''}
                  <span class="badge">${stateBadge}</span>
                  ${p.projectNumber?`<span class="muted">#${p.projectNumber}</span>`:''}
                </div>
                <h1 class="title">${p.name??'(이름 없음)'}</h1>
                ${p.summary?`<p class="summary">${p.summary}</p>`:''}
                ${p.keyMessage?`<p class="summary" style="font-weight:900">❝ ${p.keyMessage} ❞</p>`:''}

                <div class="story">
                  ${p.description?`
                    <div class="clip" id="storyClip">${fmtDesc(p.description)}</div>
                    <div class="more" id="storyToggle">자세히 보기</div>
                  `:''}
                </div>

                <div class="cta">
                  ${caseType==='completed'
                    ? (p.kakaoChatUrl?`<a class="btn btn-primary" href="${p.kakaoChatUrl}" target="_blank">🔔 다음 케이스 알림(단톡)</a>`:'')
                    : (p.kakaoChatUrl?`<a class="btn btn-primary" href="${p.kakaoChatUrl}" target="_blank">💬 남은 과제 돕기</a>`:'')
                  }
                  <a class="btn btn-secondary" href="#" id="shareBtn">🔗 링크 복사</a>
                </div>
              </div>
            </div>
          </div>
        `;

        // 스토리 토글
        const clip=document.getElementById('storyClip');
        const toggle=document.getElementById('storyToggle');
        if(clip && toggle){
          toggle.addEventListener('click',()=>{
            const open = clip.style.maxHeight==='none';
            if(open){
              clip.style.maxHeight='240px'; clip.style.overflow='hidden';
              toggle.textContent='자세히 보기';
            }else{
              clip.style.maxHeight='none'; clip.style.overflow='visible';
              toggle.textContent='간단히 보기';
            }
          });
        }

        // 공유
        const shareBtn=document.getElementById('shareBtn');
        shareBtn?.addEventListener('click',(e)=>{
          e.preventDefault();
          navigator.clipboard.writeText(window.location.href).then(()=>alert('링크가 복사되었습니다.'));
        });

      }catch(e){
        console.error(e);
        $detail.innerHTML='<div class="muted">프로젝트를 불러오지 못했습니다.</div>';
      }
    }
    render();
  </script>
</body>
</html>
