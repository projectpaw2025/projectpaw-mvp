<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>í”„ë¡œì íŠ¸ ìƒì„¸ - Project.PAW</title>
  <link rel="stylesheet" href="common.css"/>
  <link rel="stylesheet" href="app.min.css"/>
  <link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/variable/woff2/SUIT-Variable.css" rel="stylesheet"/>
  <style>
    :root{--ink:#111;--sub:#666;--line:#e7e7e7;--accent:#E87722;--bg:#f8f8f8}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:'SUIT Variable',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1040px;margin:0 auto;padding:20px 16px}

    /* ë ˆì´ì•„ì›ƒ */
    .grid{display:grid;gap:20px}
    @media(min-width:992px){.grid{grid-template-columns:1.05fr .95fr}}

    /* íŒ¨ë„ ê³µí†µ */
    .panel{background:#fff;border:1px solid var(--line);border-radius:14px;padding:18px}
    .panel h2{margin:0 0 10px;font-size:1.1rem;font-weight:900;color:var(--accent)}
    .muted{color:var(--sub)}

    /* ì¢Œì¸¡: ë¯¸ë””ì–´ */
    .media{border-radius:12px;overflow:hidden;border:1px solid var(--line);background:#fff}
    .media img{display:block;width:100%;height:56vh;min-height:280px;max-height:680px;object-fit:cover}

    /* ì§„í–‰ ë¸”ë¡(ì‚¬ì§„ ì•„ë˜) */
    .progress-lite{display:flex;gap:16px;flex-wrap:wrap}
    .kv{flex:1 1 160px;background:#fff;border:1px solid var(--line);border-radius:10px;padding:12px}
    .kv .k{font-size:.9rem;color:var(--sub)}
    .kv .v{margin-top:4px;font-weight:900}
    .kv .v.big{font-size:1.3rem}

    /* ìš°ì¸¡: íƒ€ì´í‹€/ë°°ì§€/ìš”ì•½/ìŠ¤í† ë¦¬ */
    .title{margin:0 0 6px;font-size:1.6rem;font-weight:900}
    .meta-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-weight:800;font-size:.85rem;background:#fff}
    .summary{margin:6px 0 12px;color:var(--ink)}
    .story{color:var(--ink);line-height:1.7}
    .story .clip{max-height:240px;overflow:hidden;position:relative}
    .story .more{margin-top:10px;color:var(--accent);font-weight:900;cursor:pointer}

    /* ì˜ìˆ˜ì¦ ê·¸ë¦¬ë“œ */
    .receipts{display:flex;flex-wrap:wrap;gap:8px}
    .receipts a{display:block;border:1px solid var(--line);border-radius:8px;overflow:hidden}
    .receipts img{display:block;width:110px;height:110px;object-fit:cover}

    /* CTA */
    .cta{display:flex;gap:10px;margin-top:16px}
    .btn{display:inline-block;text-decoration:none;text-align:center;border-radius:10px;padding:12px 14px;font-weight:900}
    .btn-primary{background:#FEE500;color:#111}
    .btn-secondary{background:#6b7280;color:#fff}
    @media(max-width:600px){.cta{flex-direction:column}}
  </style>
</head>
<body>
  <div data-include="header"></div>

  <main class="wrap">
    <div id="project-detail"><div class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
  </main>

  <div data-include="footer"></div>

  <script type="module">
    import { injectLayout } from './js/include.js';
    import { getProjectById } from './js/api.js';
    import { storage } from './js/firebase.js';
    import { ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

    injectLayout({ active:'project' });
    const $detail=document.getElementById('project-detail');
    const fmt=n=>Number(n||0).toLocaleString('ko-KR');

    /* ì´ë¯¸ì§€/ì˜ìˆ˜ì¦ URL ìˆ˜ì§‘ */
    function imgCands(p){
      const out=[];const push=v=>{if(typeof v==='string'&&v.trim())out.push(v.trim());};
      ['representativeImageUrl','coverUrl','mainImageUrl','thumbnailUrl','image'].forEach(k=>push(p[k]));
      ['galleryUrls','images','photos','files'].forEach(k=>{
        const arr=p[k];if(Array.isArray(arr))arr.forEach(it=>{
          if(typeof it==='string') push(it);
          else if(it&&(it.url||it.path)) push(it.url||it.path);
        });
      });
      return out;
    }
    function receiptCands(p){
      const out=[]; const push=v=>{if(typeof v==='string'&&v.trim())out.push(v.trim());};
      ['receiptUrls','receipts'].forEach(k=>{
        const v=p[k];
        if(Array.isArray(v)) v.forEach(it=>{
          if(typeof it==='string') push(it);
          else if(it&&(it.url||it.path)) push(it.url||it.path);
        });
      });
      return out;
    }
    async function toHttp(raw){
      if(!raw) return null;
      let v=String(raw).trim();
      if(/^(https?:|data:|blob:)/i.test(v)) return v;
      if(v.startsWith('/')) v=v.slice(1);
      try{return await getDownloadURL(ref(storage,v));}catch{return null;}
    }
    async function galleryUrls(p){
      const urls=await Promise.all(imgCands(p).map(toHttp));
      const uniq=[],seen=new Set(); for(const u of urls){if(u&&!seen.has(u)){seen.add(u);uniq.push(u);}}
      return uniq.length?uniq:['img/placeholder.svg'];
    }
    async function receiptUrls(p){
      const urls=await Promise.all(receiptCands(p).map(toHttp));
      const uniq=[],seen=new Set(); for(const u of urls){if(u&&!seen.has(u)){seen.add(u);uniq.push(u);}}
      return uniq; // ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´
    }

    function getId(){return new URLSearchParams(location.search).get('id');}
    function fmtDesc(text){if(!text) return '';return text.replace(/\n/g,'<br/>');}

    function whyBlock(){
      return `
        <div class="panel">
          <h2>ì™œ Project.PAWì¸ê°€?</h2>
          <p class="muted" style="line-height:1.7">
            Project.PAWëŠ” <b>ì´ë¯¸ êµ¬ì¡°ìê°€ ë¨¼ì € ì±…ì„</b>ì§„ ì‚¬ë¡€ë§Œ ê³µê°œí•©ë‹ˆë‹¤.<br/>
            <b>ì˜ìˆ˜ì¦ ì¦ë¹™</b> ê°€ëŠ¥í•œ ì¼€ì´ìŠ¤ë§Œ ë“±ë¡í•´ ë„ë•ì  í•´ì´ë¥¼ ë§‰ìŠµë‹ˆë‹¤.<br/>
            ìš°ë¦¬ëŠ” <b>ê°œì¸â†”ê°œì¸ ì§ì ‘ ì—°ê²°</b>ì„ ì§€í–¥í•©ë‹ˆë‹¤. ëˆë³´ë‹¤ ì—°ê²°ì„ ì¤‘ì‹œí•©ë‹ˆë‹¤.<br/>
            êµ¬ì¡°ìì— ëŒ€í•œ <b>ê°ì‚¬ì˜ ë§ˆìŒ</b>ì´ ë” í° êµ¬ì¡°ì˜ íŒŒì´ë¥¼ í‚¤ì›ë‹ˆë‹¤.
          </p>
        </div>`;
    }
    function betaBlock(){
      return `
        <div class="panel">
          <h2>Beta ì•ˆë‚´</h2>
          <p class="muted" style="line-height:1.7">
            âš ï¸ í˜„ì¬ Project.PAWëŠ” <b>ì‹¤í—˜ ë‹¨ê³„</b>ì…ë‹ˆë‹¤.<br/>
            í›„ì›ì€ ì¹´ì¹´ì˜¤í†¡ ë‹¨í†¡ë°©ì„ í†µí•´ ì´ë£¨ì–´ì§€ë©°, ê´€ë¦¬ìê°€ ìˆ˜ë™ìœ¼ë¡œ ëª¨ê¸ˆ/ì°¸ì—¬ ìˆ˜ì¹˜ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.<br/>
            ì •ì‹ ì„œë¹„ìŠ¤ì—ì„œëŠ” PG ê²°ì œë¥¼ í†µí•œ ìë™í™”Â·íˆ¬ëª… ì‹œìŠ¤í…œì´ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤.
          </p>
        </div>`;
    }

    async function render(){
      const id=getId();
      if(!id){$detail.innerHTML='<div class="muted">ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.</div>';return;}
      try{
        const p=await getProjectById(id);
        if(!p){$detail.innerHTML='<div class="muted">ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.</div>';return;}

        const imgs=await galleryUrls(p);
        const receipts=await receiptUrls(p);

        const goal=Number(p.goalAmount||0);
        const current=Number(p.currentAmount||0);
        const remaining=Math.max(goal-current,0);

        const caseType = p.caseType || (p.adminApproved?'ongoing':'upcoming');
        const stateBadge = caseType==='completed'?'ì™„ë£ŒÂ·ì¸ì¦' : (caseType==='upcoming'?'ì‚¬ì „ì˜ˆê³ ' : (p.adminApproved?'ì§„í–‰ì¤‘':'ëŒ€ê¸°ì¤‘'));

        $detail.innerHTML = `
          <div class="grid">
            <!-- LEFT -->
            <div>
              <div class="media panel" style="padding:0">
                <img src="${imgs[0]}" alt="project image"/>
              </div>

              <!-- ì§„í–‰ ë¸”ë¡(ì‚¬ì§„ ì•„ë˜) -->
              <div class="panel">
                <h2>ì§„í–‰</h2>
                <div class="progress-lite">
                  ${goal?`
                  <div class="kv">
                    <div class="k">ëª©í‘œ ê¸ˆì•¡</div>
                    <div class="v">â‚©${fmt(goal)}</div>
                  </div>`:''}
                  <div class="kv">
                    <div class="k">í˜„ì¬ ëª¨ê¸ˆ</div>
                    <div class="v">â‚©${fmt(current)}</div>
                  </div>
                  ${goal?`
                  <div class="kv">
                    <div class="k">ë‚¨ì€ ê¸ˆì•¡</div>
                    <div class="v big">â‚©${fmt(remaining)}</div>
                  </div>`:''}
                  <div class="kv">
                    <div class="k">ì—°ê²°ëœ ë§ˆìŒ</div>
                    <div class="v">${fmt(p.supporterCount||0)}ëª…</div>
                  </div>
                </div>
              </div>

              <!-- Why & Beta (ì‚¬ì§„ ì•„ë˜) -->
              ${whyBlock()}
              ${betaBlock()}

              <!-- ì˜ìˆ˜ì¦ (ìˆì„ ë•Œë§Œ) -->
              ${Array.isArray(receipts)&&receipts.length?`
                <div class="panel">
                  <h2>ğŸ“ ì˜ìˆ˜ì¦Â·ì§„ë£Œë‚´ì—­</h2>
                  <div class="receipts">
                    ${receipts.map(u=>`<a href="${u}" target="_blank" rel="noopener"><img src="${u}" alt="receipt"/></a>`).join('')}
                  </div>
                  <p class="muted" style="margin-top:8px;font-size:.9rem">â€» êµ¬ì¡°ìê°€ ì§ì ‘ ê²°ì œí•œ ë‚´ì—­ì„ ì¦ë¹™ìœ¼ë¡œ ê³µê°œí•©ë‹ˆë‹¤.</p>
                </div>
              `:''}
            </div>

            <!-- RIGHT -->
            <div>
              <div class="panel">
                <div class="meta-row">
                  ${p.problemType?`<span class="badge">${p.problemType}</span>`:''}
                  <span class="badge">${stateBadge}</span>
                  ${p.projectNumber?`<span class="muted">#${p.projectNumber}</span>`:''}
                </div>
                <h1 class="title">${p.name??'(ì´ë¦„ ì—†ìŒ)'}</h1>
                ${p.summary?`<p class="summary">${p.summary}</p>`:''}
                ${p.keyMessage?`<p class="summary" style="font-weight:900">â ${p.keyMessage} â</p>`:''}

                <div class="story">
                  ${p.description?`
                    <div class="clip" id="storyClip">${fmtDesc(p.description)}</div>
                    <div class="more" id="storyToggle">ìì„¸íˆ ë³´ê¸°</div>
                  `:''}
                </div>

                <div class="cta">
                  ${caseType==='completed'
                    ? (p.kakaoChatUrl?`<a class="btn btn-primary" href="${p.kakaoChatUrl}" target="_blank">ğŸ”” ë‹¤ìŒ ì¼€ì´ìŠ¤ ì•Œë¦¼(ë‹¨í†¡)</a>`:'')
                    : (p.kakaoChatUrl?`<a class="btn btn-primary" href="${p.kakaoChatUrl}" target="_blank">ğŸ’¬ ë‚¨ì€ ê³¼ì œ ë•ê¸°</a>`:'')
                  }
                  <a class="btn btn-secondary" href="#" id="shareBtn">ğŸ”— ë§í¬ ë³µì‚¬</a>
                </div>
              </div>
            </div>
          </div>
        `;

        // ìŠ¤í† ë¦¬ í† ê¸€
        const clip=document.getElementById('storyClip');
        const toggle=document.getElementById('storyToggle');
        if(clip && toggle){
          toggle.addEventListener('click',()=>{
            const open = clip.style.maxHeight==='none';
            if(open){
              clip.style.maxHeight='240px'; clip.style.overflow='hidden';
              toggle.textContent='ìì„¸íˆ ë³´ê¸°';
            }else{
              clip.style.maxHeight='none'; clip.style.overflow='visible';
              toggle.textContent='ê°„ë‹¨íˆ ë³´ê¸°';
            }
          });
        }

        // ê³µìœ 
        const shareBtn=document.getElementById('shareBtn');
        shareBtn?.addEventListener('click',(e)=>{
          e.preventDefault();
          navigator.clipboard.writeText(window.location.href).then(()=>alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'));
        });

      }catch(e){
        console.error(e);
        $detail.innerHTML='<div class="muted">í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
      }
    }
    render();
  </script>
</body>
</html>
