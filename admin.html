<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>관리자 페이지 - Project.PAW</title>
<link rel="stylesheet" href="common.css"/>
<link rel="stylesheet" href="app.min.css"/>
<style>
.wrap{max-width:960px;margin:0 auto;padding:20px 16px}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{border:1px solid #e5e7eb;padding:10px;font-size:.9rem;text-align:left;vertical-align:top}
th{background:#f9fafb}
.actions{display:flex;gap:6px;flex-wrap:wrap}
button{padding:6px 10px;border-radius:8px;border:1px solid #ccc;cursor:pointer;font-size:.85rem}
button.approve{background:#16a34a;color:#fff;border:none}
button.delete{background:#dc2626;color:#fff;border:none}
button.edit{background:#2563eb;color:#fff;border:none}
button.full-edit{background:#9333ea;color:#fff;border:none}
/* 추가: 완료/재오픈 버튼 */
button.complete{background:#374151;color:#fff;border:none}
button.reopen{background:#f59e0b;color:#111;border:none}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.75rem;border:1px solid #e5e7eb;background:#fff}
.badge.completed{background:#e5e7eb;border-color:#e5e7eb;color:#374151}
.badge.inprogress{background:#eef2ff;border-color:#c7d2fe;color:#1f2937}
.error{color:#dc2626;font-size:.9rem;margin-top:10px;text-align:center}
form.editor{margin-top:30px;display:grid;gap:12px;max-width:500px}
form.editor label{font-weight:700}
form.editor input,form.editor textarea{padding:8px;border:1px solid #ddd;border-radius:8px}
@media(max-width:600px){
  table{font-size:.8rem}
  .actions{flex-direction:column}
  button{width:100%}
}

/* 모달 */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:9999;}
.modal .box{background:#fff;border-radius:10px;max-width:700px;width:95%;
  max-height:90vh;overflow:auto;padding:20px;}
.modal h2{margin-top:0}
.modal form{display:grid;gap:12px}
.modal label{font-weight:700}
.modal input,.modal textarea{padding:8px;border:1px solid #ddd;border-radius:8px}
.modal textarea{min-height:100px;resize:vertical}
.modal .btns{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
</style>
</head>
<body>
  <main class="wrap">
    <h1>관리자 로그인</h1>
    <p>이메일과 비밀번호로 로그인하세요.</p>
    <form id="loginForm" style="margin-bottom:30px;display:grid;gap:12px;max-width:400px">
      <input type="email" id="email" placeholder="이메일" required/>
      <input type="password" id="password" placeholder="비밀번호" required/>
      <button type="submit">로그인</button>
      <div id="error" class="error"></div>
    </form>

    <section id="adminSection" style="display:none">
      <h2>프로젝트 승인 & 관리</h2>
      <table>
        <thead>
          <tr>
            <th>번호</th>
            <th>프로젝트명</th>
            <th>구조자</th>
            <th>요약</th>
            <th>연락처</th>
            <th>관리자 한마디</th>
            <th>상태</th>
            <th>액션</th>
          </tr>
        </thead>
        <tbody id="projects-body">
          <tr><td colspan="8" class="muted">불러오는 중...</td></tr>
        </tbody>
      </table>

      <!-- 원본 editorSection (수치/링크) -->
      <section id="editorSection" style="display:none">
        <h2>프로젝트 수치/링크 업데이트</h2>
        <form id="editorForm" class="editor">
          <input type="hidden" id="edit-id"/>

          <label>프로젝트 번호 (projectNumber)</label>
          <input type="number" id="edit-projectNumber"/>

          <label>조회수 (views)</label>
          <input type="number" id="edit-views"/>

          <label>등록일자 (createdAt)</label>
          <input type="date" id="edit-createdAt"/>

          <label>승인일자 (approvedAt)</label>
          <input type="date" id="edit-approvedAt"/>

          <label>구조자 계좌번호</label>
          <input type="text" id="edit-rescuerAccount"/>

          <label>모금액 (currentAmount)</label>
          <input type="number" id="edit-currentAmount"/>

          <label>참여자 수 (supporterCount)</label>
          <input type="number" id="edit-supporterCount"/>

          <label>목표 금액 (goalAmount)</label>
          <input type="number" id="edit-goalAmount"/>

          <label>한줄 메시지 (keyMessage)</label>
          <input type="text" id="edit-keyMessage"/>

          <label>카카오톡 오픈채팅 링크</label>
          <input type="url" id="edit-kakaoChatUrl"/>

          <button type="submit">저장하기</button>
        </form>
      </section>
    </section>
  </main>

  <!-- 추가: 전체 문구 편집 모달 -->
  <div class="modal" id="editModal">
    <div class="box">
      <h2>프로젝트 전체 문구 편집</h2>
      <form id="fullEditForm">
        <input type="hidden" id="pid"/>

        <label>프로젝트명</label>
        <input type="text" id="edit-name"/>

        <label>구조자 이름</label>
        <input type="text" id="edit-rescuerName"/>

        <label>요약</label>
        <input type="text" id="edit-summary"/>

        <label>스토리 설명</label>
        <textarea id="edit-description"></textarea>

        <label>대표 이미지 URL</label>
        <input type="url" id="edit-representativeImageUrl"/>

        <label>추가 이미지(,로 구분)</label>
        <textarea id="edit-galleryUrls"></textarea>

        <label>영수증 이미지(,로 구분)</label>
        <textarea id="edit-receiptUrls"></textarea>

        <label>관리자 한마디</label>
        <textarea id="edit-adminMessage"></textarea>

        <div class="btns">
          <button type="button" id="closeModal">닫기</button>
          <button type="submit" style="background:#2563eb;color:#fff;">저장하기</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { app } from "./js/firebase.js";
    import { fetchAllProjects, approveProject, deleteProject } from "./js/api.js";

    const auth = getAuth(app);
    const db = getFirestore(app);

    const form = document.getElementById("loginForm");
    const errorDiv = document.getElementById("error");
    const adminSection = document.getElementById("adminSection");
    const $body = document.getElementById("projects-body");
    const editorSection = document.getElementById("editorSection");
    const editorForm = document.getElementById("editorForm");

    // 모달 요소 (조건부 바인딩)
    const modal=document.getElementById("editModal");
    const closeModalBtn=document.getElementById("closeModal");
    const fullEditForm=document.getElementById("fullEditForm");

    async function isAdminUser(uid){
      const docRef = doc(db, "admins", uid);
      const snap = await getDoc(docRef);
      return snap.exists();
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      errorDiv.textContent = "";
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        const ok = await isAdminUser(user.uid);
        if (!ok) { errorDiv.textContent = "⚠️ 관리자 권한이 없는 계정입니다."; return; }

        form.style.display = "none";
        adminSection.style.display = "block";
        render();

      } catch (err) {
        errorDiv.textContent = "로그인 실패: " + (err.message || "");
      }
    });

    // 상태 라벨
    function fmtStatus(p){
      const s = (p.status || 'in_progress');
      const approved = p.adminApproved ? "승인됨 ✅" : "대기중 ⏳";
      const badge = s === 'completed'
        ? '<span class="badge completed">완료</span>'
        : '<span class="badge inprogress">진행중</span>';
      return approved + ' · ' + badge;
    }

    async function render(){
      try{
        const list=await fetchAllProjects();
        if(!list.length){
          $body.innerHTML='<tr><td colspan="8" class="muted">아직 등록된 프로젝트가 없습니다.</td></tr>';
          return;
        }
        $body.innerHTML=list.map(p=>`
          <tr>
            <td>${p.projectNumber ? `PAW #${p.projectNumber}` : '-'}</td>
            <td>${p.name??'(이름 없음)'}</td>
            <td>${p.rescuerName??'-'}</td>
            <td>${p.summary??''}</td>
            <td>${p.privateContact??''}</td>
            <td>${p.adminMessage??''}</td>
            <td>${fmtStatus(p)}</td>
            <td class="actions">
              ${!p.adminApproved?`<button class="approve" data-id="${p.id}">승인</button>`:''}
              <button class="edit" data-id="${p.id}">수치편집</button>
              <button class="full-edit" data-id="${p.id}">문구편집</button>
              ${p.status==='completed'
                ? `<button class="reopen" data-id="${p.id}">재오픈</button>`
                : `<button class="complete" data-id="${p.id}">완료</button>`}
              <button class="delete" data-id="${p.id}">삭제</button>
            </td>
          </tr>`).join('');
      }catch(e){
        $body.innerHTML='<tr><td colspan="8" class="muted">프로젝트를 불러오지 못했습니다.</td></tr>';
      }
    }

    // 오늘(YYYY-MM-DD)
    function todayStr(){
      const d = new Date();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${d.getFullYear()}-${mm}-${dd}`;
    }

    $body.addEventListener('click', async e=>{
      if(e.target.matches('.approve')){
        if(confirm("승인하시겠습니까?")){
          await approveProject(e.target.dataset.id);
          alert("승인되었습니다.");
          render();
        }
      }
      if(e.target.matches('.delete')){
        if(confirm("삭제하시겠습니까?")){
          await deleteProject(e.target.dataset.id);
          alert("삭제되었습니다.");
          render();
        }
      }
      if(e.target.matches('.edit')){
        // 원본 editorSection 로직 그대로
        const id=e.target.dataset.id;
        const all=await fetchAllProjects();
        const p=all.find(x=>x.id===id);
        if(!p)return;
        document.getElementById("edit-id").value=id;
        document.getElementById("edit-projectNumber").value=p.projectNumber ?? "";
        document.getElementById("edit-views").value=p.views ?? 0;
        document.getElementById("edit-createdAt").value=p.createdAt ? String(p.createdAt).split("T")[0] : "";
        document.getElementById("edit-approvedAt").value=p.approvedAt ? String(p.approvedAt).split("T")[0] : "";
        document.getElementById("edit-rescuerAccount").value=p.rescuerAccount ?? "";
        document.getElementById("edit-currentAmount").value=p.currentAmount||0;
        document.getElementById("edit-supporterCount").value=p.supporterCount||0;
        document.getElementById("edit-goalAmount").value=p.goalAmount||0;
        document.getElementById("edit-keyMessage").value=p.keyMessage||"";
        document.getElementById("edit-kakaoChatUrl").value=p.kakaoChatUrl||"";
        editorSection.style.display="block";
        editorForm.scrollIntoView({behavior:"smooth"});
      }
      if(e.target.matches('.full-edit') && modal){
        // 모달 편집
        const id=e.target.dataset.id;
        const all=await fetchAllProjects();
        const p=all.find(x=>x.id===id);
        if(!p)return;

        document.getElementById("pid").value=id;
        document.getElementById("edit-name").value=p.name||"";
        document.getElementById("edit-rescuerName").value=p.rescuerName||"";
        document.getElementById("edit-summary").value=p.summary||"";
        document.getElementById("edit-description").value=p.description||"";
        document.getElementById("edit-representativeImageUrl").value=p.representativeImageUrl||"";
        document.getElementById("edit-galleryUrls").value=(p.galleryUrls||[]).join(",");
        document.getElementById("edit-receiptUrls").value=(p.receiptUrls||[]).join(",");
        document.getElementById("edit-adminMessage").value=p.adminMessage||"";

        modal.style.display="flex";
      }

      // --- 완료 처리 ---
      if(e.target.matches('.complete')){
        const id=e.target.dataset.id;
        if(!id) return;

        // 링크/메모 입력(선택)
        const reviewUrl = prompt("후기 URL을 입력하세요(선택, Enter로 건너뛰기):","") || "";
        const thanksCardUrl = prompt("감사카드 URL을 입력하세요(선택, Enter로 건너뛰기):","") || "";

        if(confirm("이 프로젝트를 '완료' 상태로 전환할까요? 이후 기부 버튼은 숨겨지고 카드에 '완료' 배지가 표시됩니다.")){
          try{
            // 현 시점 데이터 스냅샷을 위해 한 번 더 조회
            const all=await fetchAllProjects();
            const p=all.find(x=>x.id===id) || {};
            const payload = {
              status: 'completed',
              completedAt: todayStr(),
              finalRaised: Number(p.currentAmount||0),
              finalSupporters: Number(p.supporterCount||0),
              reviewUrl: reviewUrl.trim() || (p.reviewUrl||""),
              thanksCardUrl: thanksCardUrl.trim() || (p.thanksCardUrl||"")
            };
            await updateDoc(doc(db,"projects",id), payload);
            alert("완료 처리되었습니다.");
            render();
          }catch(err){
            alert("완료 처리 실패: "+(err.message||""));
          }
        }
      }

      // --- 재오픈 처리 ---
      if(e.target.matches('.reopen')){
        const id=e.target.dataset.id;
        if(!id) return;
        if(confirm("이 프로젝트를 다시 '진행중'으로 전환할까요?")){
          try{
            await updateDoc(doc(db,"projects",id), { status: 'in_progress' });
            alert("재오픈되었습니다.");
            render();
          }catch(err){
            alert("재오픈 실패: "+(err.message||""));
          }
        }
      }
    });

    if(closeModalBtn){
      closeModalBtn.addEventListener("click",()=>{modal.style.display="none";});
    }

    editorForm.addEventListener("submit", async e=>{
      e.preventDefault();
      const id=document.getElementById("edit-id").value;
      if(!id)return alert("잘못된 프로젝트 ID");

      const data={
        projectNumber: Number(document.getElementById("edit-projectNumber").value)||null,
        views: Number(document.getElementById("edit-views").value)||0,
        createdAt: document.getElementById("edit-createdAt").value||null,
        approvedAt: document.getElementById("edit-approvedAt").value||null,
        rescuerAccount: document.getElementById("edit-rescuerAccount").value.trim(),
        currentAmount: Number(document.getElementById("edit-currentAmount").value)||0,
        supporterCount: Number(document.getElementById("edit-supporterCount").value)||0,
        goalAmount: Number(document.getElementById("edit-goalAmount").value)||0,
        keyMessage: document.getElementById("edit-keyMessage").value.trim(),
        kakaoChatUrl: document.getElementById("edit-kakaoChatUrl").value.trim()
      };

      try{
        await updateDoc(doc(db,"projects",id),data);
        alert("프로젝트가 업데이트되었습니다.");
        render();
      }catch(err){
        alert("업데이트 실패: "+err.message);
      }
    });

    if(fullEditForm){
      fullEditForm.addEventListener("submit",async e=>{
        e.preventDefault();
        const id=document.getElementById("pid").value;
        if(!id)return alert("잘못된 프로젝트 ID");

        const data={
          name: document.getElementById("edit-name").value.trim(),
          rescuerName: document.getElementById("edit-rescuerName").value.trim(),
          summary: document.getElementById("edit-summary").value.trim(),
          description: document.getElementById("edit-description").value.trim(),
          representativeImageUrl: document.getElementById("edit-representativeImageUrl").value.trim(),
          galleryUrls: document.getElementById("edit-galleryUrls").value.split(",").map(s=>s.trim()).filter(Boolean),
          receiptUrls: document.getElementById("edit-receiptUrls").value.split(",").map(s=>s.trim()).filter(Boolean),
          adminMessage: document.getElementById("edit-adminMessage").value.trim()
        };

        try{
          await updateDoc(doc(db,"projects",id),data);
          alert("프로젝트 전체 문구가 업데이트되었습니다.");
          modal.style.display="none";
          render();
        }catch(err){
          alert("업데이트 실패: "+err.message);
        }
      });
    }
  </script>
</body>
</html>
