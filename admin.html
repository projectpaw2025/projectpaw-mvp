<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>관리자 — Project.PAW</title>
  <link rel="stylesheet" href="common.css"/>
  <link rel="stylesheet" href="app.min.css"/>
  <style>
    .wrap{max-width:1040px;margin:0 auto;padding:20px 16px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 16px}
    .toolbar input,.toolbar select{padding:10px;border:1px solid #e5e7eb;border-radius:10px}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
    .card{display:flex;flex-direction:column;gap:10px;padding:12px}
    .row{display:flex;gap:8px}
    .row>*{flex:1}
    label{display:block;font-weight:700;margin-bottom:6px}
    input{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px}
    .chip{display:inline-block;padding:2px 10px;border-radius:999px;font-size:.85rem;border:1px solid #e5e7eb;color:#374151}
    .chip.ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
    .chip.pending{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
    .actions{display:flex;gap:8px;justify-content:flex-end}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid #111;background:#111;color:#fff}
    .btn.secondary{background:#fff;color:#111;border:1px solid #e5e7eb}
  </style>
</head>
<body>
  <div data-include="header"></div>
  <main class="wrap">
    <h1 style="font-size:1.5rem;font-weight:900;margin:0 0 10px">관리자 대시보드</h1>
    <p class="muted">임시 보안(비밀번호)만 적용됨. 실서비스는 Firebase Auth/Rules 필요.</p>

    <div class="toolbar">
      <input id="search" placeholder="이름/요약/설명/등록자 카카오ID 검색"/>
      <select id="filter">
        <option value="all">전체</option>
        <option value="pending">대기</option>
        <option value="approved">승인</option>
      </select>
      <button id="refresh" class="btn secondary">새로고침</button>
    </div>

    <div id="cards" class="cards"></div>
  </main>
  <div data-include="footer"></div>

  <script type="module">
    import { injectLayout } from './js/include.js';
    import { apiListProjects, apiToggleApprove } from './js/api.js';
    injectLayout({active:'about'});

    // 간단 비밀번호 보호
    (function(){
      const EXPECT = 'paw-admin';
      const viaQuery = new URL(location.href).searchParams.get('key');
      if(viaQuery === EXPECT) return;
      const input = prompt('관리자 비밀번호:');
      if(input !== EXPECT){ alert('거부'); location.href='index.html'; }
    })();

    const $cards = document.getElementById('cards');
    const $search = document.getElementById('search');
    const $filter = document.getElementById('filter');
    const $refresh = document.getElementById('refresh');

    function match(p,q,f){
      if(f==='pending' && p.adminApproved) return false;
      if(f==='approved' && !p.adminApproved) return false;
      if(!q) return true;
      const hay=[p.name,p.summary,p.description,p.registrantKakaoId]
        .map(v=>(v??'')+'').join(' ').toLowerCase();
      return hay.includes(q.toLowerCase());
    }

    function fmt(n){ return Number(n||0).toLocaleString('ko-KR'); }

    async function render(){
      const status = $filter.value;   // ✅ 선택된 값 그대로 전달
      const list = (await apiListProjects({ status }))
        .filter(p=>match(p,$search.value.trim(),$filter.value));
      if(!list.length){ 
        $cards.innerHTML = '<div class="muted">표시할 프로젝트 없음</div>'; 
        return; 
      }
      $cards.innerHTML = list.map(p => `
        <div class="card" data-id="${p.id}">
          <div class="row" style="align-items:center;gap:12px">
            <img src="${p.representativeImageUrl || 'img/placeholder.svg'}" 
                 style="width:88px;height:88px;object-fit:cover;border-radius:10px;border:1px solid #eee"/>
            <div style="flex:1">
              <div style="font-weight:900">
                ${p.name ?? '(이름 없음)'} 
                <span class="${p.adminApproved?'chip ok':'chip pending'}" style="margin-left:6px">
                  ${p.adminApproved?'승인':'대기'}
                </span>
              </div>
              <div class="muted">${p.summary ?? ''}</div>
              <div class="muted">목표 ${fmt(p.goalAmount)} · 부담 ${fmt(p.rescuerContribution)}</div>
            </div>
          </div>
          <div class="actions">
            <a class="btn secondary" href="project.html?id=${encodeURIComponent(p.id)}">상세보기</a>
            <button class="btn secondary" data-action="toggle">
              ${p.adminApproved?'승인 해제':'승인하기'}
            </button>
          </div>
        </div>
      `).join('');
    }

    $cards.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-action]');
      if(!btn) return;
      const card = btn.closest('.card');
      const id = card?.dataset?.id;
      if(!id) return;
      if(btn.dataset.action==='toggle'){
        const will = btn.textContent.includes('해제') ? false : true;
        await apiToggleApprove(id, will);
        render();
      }
    });

    $search.addEventListener('input', render);
    $filter.addEventListener('change', render);
    $refresh.addEventListener('click', render);

    // ✅ 초기 진입 시 무조건 'all'로 고정
    $filter.value = 'all';
    render();
  </script>
</body>
</html>
