<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ê´€ë¦¬ì â€” Project.PAW</title>
  <link rel="stylesheet" href="common.css"/>
  <link rel="stylesheet" href="app.min.css"/>
  <style>
    .container-narrow { max-width: 1040px; margin: 0 auto; padding: 16px; }
    .admin-toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin: 8px 0 16px; }
    .admin-toolbar input, .admin-toolbar select { padding:10px; border:1px solid #e5e7eb; border-radius:8px; }
    .cards { display:grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap:12px; }
    .card { border:1px solid #eee; border-radius:12px; padding:12px; background:#fff; display:flex; flex-direction:column; gap:10px; }
    .card h3 { margin:0; font-size:1.1rem; }
    .row { display:flex; gap:8px; }
    .row > * { flex:1; }
    label { display:block; font-weight:600; margin-bottom:6px; }
    input[type="text"], input[type="number"], input[type="url"] { width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:8px; }
    .tag { display:inline-block; padding:2px 8px; border-radius:999px; font-size:.8rem; border:1px solid #ddd; }
    .tag.pending { background:#fff7ed; border-color:#fed7aa; color:#9a3412; }
    .tag.ok { background:#ecfdf5; border-color:#bbf7d0; color:#065f46; }
    .btn { padding:10px 12px; border-radius:10px; border:1px solid #111; background:#111; color:#fff; cursor:pointer; }
    .btn.secondary { background:#fff; color:#111; border:1px solid #ddd; }
    .card-actions { display:flex; gap:8px; justify-content:flex-end; }
    .meta { font-size:.85rem; color:#6b7280; }
    .divider { height:1px; background:#f1f5f9; margin:6px 0; }
    .note { font-size:.85rem; color:#6b7280; }
    .danger { color:#b91c1c; }
  </style>
</head>
<body>
  <div data-include="header"></div>

  <main class="container-narrow" style="padding: 8px 0 24px">
    <h2>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>
    <p class="note">âš ï¸ ì´ í˜ì´ì§€ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œë§Œ ë™ì‘í•˜ëŠ” ì„ì‹œ ê´€ë¦¬ì í™”ë©´ì…ë‹ˆë‹¤. ì‹¤ì œ ìš´ì˜ ì‹œ ì„œë²„/ì¸ì¦ì„ ë¶™ì´ì„¸ìš”.</p>

    <div class="admin-toolbar">
      <input id="search" type="text" placeholder="ì´ë¦„/ìš”ì•½/ì„¤ëª…/ë“±ë¡ì ì¹´ì¹´ì˜¤ID ê²€ìƒ‰"/>
      <select id="filter">
        <option value="all">ì „ì²´</option>
        <option value="pending">ëŒ€ê¸°</option>
        <option value="approved">ìŠ¹ì¸</option>
      </select>
      <button id="refresh" class="btn secondary">ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <div id="cards" class="cards"></div>
  </main>

  <div data-include="footer"></div>

  <script type="module">
    import { injectLayout } from "./js/include.js";
    injectLayout({ active: "about" }); // í—¤ë” í™œì„±í‘œì‹œëŠ” ì•„ë¬´ê±°ë‚˜, ì–´ì°¨í”¼ ê´€ë¦¬ì ì „ìš©
  </script>

  <script>
    // ====== ë§¤ìš° ë‹¨ìˆœí•œ í”„ë¡ íŠ¸ ë³´ì•ˆ (ì§„ì§œ ë³´ì•ˆ ì•„ë‹˜) ======
    (function adminGate() {
      const EXPECT = "paw-admin"; // ğŸ”’ ì„ì‹œ ë¹„ë²ˆ â€” ë°°í¬ ì „ ë°”ê¾¸ì„¸ìš”
      const viaQuery = new URL(location.href).searchParams.get("key");
      if (viaQuery === EXPECT) return;
      const input = prompt("ê´€ë¦¬ì í˜ì´ì§€ ì ‘ì† ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
      if (input !== EXPECT) {
        alert("ì ‘ê·¼ ê±°ë¶€");
        location.href = "index.html";
      }
    })();
  </script>

  <script>
    // ====== ë°ì´í„° ì ‘ê·¼ ìœ í‹¸ ======
    function readProjects() {
      try {
        const raw = localStorage.getItem("projects");
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch (e) { return []; }
    }
    function writeProjects(arr) {
      localStorage.setItem("projects", JSON.stringify(arr || []));
    }
    function updateProject(patch) {
      const arr = readProjects();
      const idx = arr.findIndex(x => x.id === patch.id);
      if (idx >= 0) arr[idx] = { ...arr[idx], ...patch };
      writeProjects(arr);
    }
    function deleteProject(id) {
      const arr = readProjects().filter(x => x.id !== id);
      writeProjects(arr);
    }

    // ====== ë Œë”ë§ ======
    const $cards = document.getElementById("cards");
    const $search = document.getElementById("search");
    const $filter = document.getElementById("filter");
    const $refresh = document.getElementById("refresh");

    function matchesFilter(p, query, filter) {
      if (filter === "pending" && p.adminApproved) return false;
      if (filter === "approved" && !p.adminApproved) return false;
      if (!query) return true;
      const hay = [
        p.name, p.rescuerName, p.summary, p.description,
        p.registrantKakaoId, p.hospitalName, p.bankAccount, p.kakaoInviteLink
      ].map(v => (v ?? "") + "").join(" ").toLowerCase();
      return hay.includes(query.toLowerCase());
    }

    function fmtKRW(n) {
      const x = Number(n || 0);
      return x.toLocaleString("ko-KR") + "ì›";
    }

    function render() {
      const projects = readProjects()
        .sort((a,b) => (b.createdAt||0) - (a.createdAt||0));
      const q = $search.value.trim();
      const f = $filter.value;

      const list = projects.filter(p => matchesFilter(p, q, f));
      if (!list.length) {
        $cards.innerHTML = `<div class="note">í‘œì‹œí•  í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      $cards.innerHTML = list.map(p => {
        const statusTag = p.adminApproved
          ? `<span class="tag ok">ìŠ¹ì¸</span>`
          : `<span class="tag pending">ëŒ€ê¸°</span>`;

        const cover = p.representativeImage || "img/placeholder.svg";
        const goal = fmtKRW(p.goalAmount);
        const contrib = fmtKRW(p.rescuerContribution);

        return `
        <div class="card" data-id="${p.id}">
          <div class="row" style="gap:12px; align-items:center">
            <img src="${cover}" alt="cover" style="width:88px;height:88px;object-fit:cover;border-radius:10px;border:1px solid #eee"/>
            <div style="flex:1">
              <h3>${p.name ?? "(ì´ë¦„ ì—†ìŒ)"} <small class="meta">by ${p.rescuerName ?? "-"}</small></h3>
              <div class="meta">${p.summary ?? ""}</div>
              <div class="meta">ëª©í‘œ ${goal} Â· êµ¬ì¡°ì ë¶€ë‹´ ${contrib}</div>
              <div>${statusTag}</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div>
              <label>ë³‘ì›ëª…</label>
              <input type="text" name="hospitalName" placeholder="ì˜ˆ: â—‹â—‹ë™ë¬¼ë³‘ì›" value="${p.hospitalName ?? ""}"/>
            </div>
            <div>
              <label>ê³„ì¢Œë²ˆí˜¸</label>
              <input type="text" name="bankAccount" placeholder="ì˜ˆ: êµ­ë¯¼ 000000-00-000000" value="${p.bankAccount ?? ""}"/>
            </div>
          </div>
          <div>
            <label>ì¹´ì¹´ì˜¤í†¡ ì´ˆëŒ€ë§í¬</label>
            <input type="url" name="kakaoInviteLink" placeholder="https://open.kakao.com/o/xxxxxx" value="${p.kakaoInviteLink ?? ""}"/>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div>
              <label>ë“±ë¡ì ì¹´ì¹´ì˜¤í†¡ ID</label>
              <input type="text" name="registrantKakaoId" value="${p.registrantKakaoId ?? ""}" disabled/>
              <div class="note">ë“±ë¡ ì‹œ ì œì¶œëœ ì •ë³´(ì½ê¸° ì „ìš©)</div>
            </div>
            <div>
              <label>í”„ë¡œì íŠ¸ ID</label>
              <input type="text" value="${p.id}" disabled/>
              <div class="note">ë‚´ë¶€ ì‹ë³„ì</div>
            </div>
          </div>

          <div class="card-actions">
            <button class="btn secondary" data-action="preview">ìƒì„¸ë³´ê¸°</button>
            <button class="btn secondary" data-action="toggle">${p.adminApproved ? "ìŠ¹ì¸ í•´ì œ" : "ìŠ¹ì¸í•˜ê¸°"}</button>
            <button class="btn" data-action="save">ì €ì¥</button>
            <button class="btn secondary danger" data-action="delete">ì‚­ì œ</button>
          </div>
        </div>`;
      }).join("");
    }

    // ====== ì´ë²¤íŠ¸ ë°”ì¸ë”© ======
    $cards.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;

      const card = btn.closest(".card");
      const id = card?.dataset?.id;
      if (!id) return;

      const action = btn.dataset.action;

      if (action === "preview") {
        location.href = "project.html?id=" + encodeURIComponent(id);
        return;
      }

      if (action === "toggle") {
        const arr = readProjects();
        const p = arr.find(x => x.id === id);
        if (!p) return;
        p.adminApproved = !p.adminApproved;
        writeProjects(arr);
        render();
        return;
      }

      if (action === "save") {
        const hospitalName = card.querySelector('input[name="hospitalName"]').value.trim();
        const bankAccount = card.querySelector('input[name="bankAccount"]').value.trim();
        const kakaoInviteLink = card.querySelector('input[name="kakaoInviteLink"]').value.trim();
        updateProject({ id, hospitalName, bankAccount, kakaoInviteLink });
        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        return;
      }

      if (action === "delete") {
        if (!confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;
        deleteProject(id);
        render();
        return;
      }
    });

    $search.addEventListener("input", render);
    $filter.addEventListener("change", render);
    $refresh.addEventListener("click", render);

    // ì´ˆê¸° ë Œë”
    render();
  </script>
</body>
</html>
