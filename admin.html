<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>관리자 승인 - Project.PAW</title>
  <link rel="stylesheet" href="common.css"/>
  <link rel="stylesheet" href="app.min.css"/>
  <style>
    body { background:#fafafa; font-family:'Pretendard',sans-serif; }
    .container { max-width:960px; margin:40px auto; padding:0 16px; }
    h1 { font-size:1.5rem; font-weight:700; margin-bottom:20px; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { border:1px solid #ddd; padding:10px; font-size:.95rem; }
    th { background:#f7f7f7; text-align:left; }
    td img { max-width:120px; border-radius:6px; }
    .btn { display:inline-block; padding:8px 14px; border-radius:8px; font-weight:600; cursor:pointer; text-decoration:none; font-size:.9rem; }
    .btn.approve { background:#4caf50; color:#fff; border:none; margin-right:6px; }
    .btn.delete { background:#f44336; color:#fff; border:none; }
    .muted { font-size:.85rem; color:#777; }
    footer { margin-top:60px; padding:30px; text-align:center; font-size:.9rem; color:#888; border-top:1px solid #eee; }
  </style>
</head>
<body>
  <div data-include="header"></div>

  <main class="container">
    <h1>프로젝트 승인 / 관리</h1>
    <p class="muted">※ 이 페이지는 관리자 전용입니다.</p>

    <table>
      <thead>
        <tr>
          <th>대표 이미지</th>
          <th>프로젝트 이름</th>
          <th>요약</th>
          <th>상태</th>
          <th>액션</th>
        </tr>
      </thead>
      <tbody id="projects-body">
        <tr><td colspan="5" class="muted">불러오는 중...</td></tr>
      </tbody>
    </table>
  </main>

  <div data-include="footer"></div>

  <!-- 내부 로직 -->
  <script type="module">
    import { injectLayout } from './js/include.js';
    import { fetchAllProjects, approveProject, deleteProject } from './assets/js/api.js';

    injectLayout({ active:'admin' });

    const $body = document.getElementById('projects-body');

    function fmtStatus(p){
      if(p.adminApproved) return "승인됨";
      return "대기중";
    }

    async function render(){
      try {
        const list = await fetchAllProjects();
        if(!list.length){
          $body.innerHTML = '<tr><td colspan="5" class="muted">등록된 프로젝트가 없습니다.</td></tr>';
          return;
        }
        $body.innerHTML = list.map(p => `
          <tr>
            <td><img src="${p.coverUrl || (Array.isArray(p.images)&&p.images[0]) || 'img/placeholder.svg'}"/></td>
            <td>${p.name ?? ''}</td>
            <td>${p.summary ?? ''}</td>
            <td>${fmtStatus(p)}</td>
            <td>
              ${!p.adminApproved ? `<button class="btn approve" data-id="${p.id}" data-action="approve">승인</button>` : ''}
              <button class="btn delete" data-id="${p.id}" data-action="delete">삭제</button>
            </td>
          </tr>
        `).join('');
      } catch (e) {
        console.error(e);
        $body.innerHTML = '<tr><td colspan="5" class="muted">불러오기 실패</td></tr>';
      }
    }

    $body.addEventListener('click', async e => {
      if(e.target.dataset.action){
        const id = e.target.dataset.id;
        const action = e.target.dataset.action;
        if(action === 'approve'){
          if(confirm("이 프로젝트를 승인하시겠습니까?")){
            try {
              await approveProject(id);
              alert("승인 완료");
              render();
            } catch(err){
              alert("승인 실패: " + err.message);
            }
          }
        }
        if(action === 'delete'){
          if(confirm("정말 삭제하시겠습니까?")){
            try {
              await deleteProject(id);
              alert("삭제 완료");
              render();
            } catch(err){
              alert("삭제 실패: " + err.message);
            }
          }
        }
      }
    });

    render();
  </script>
</body>
</html>
