<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ê´€ë¦¬ì í˜ì´ì§€ - Project.PAW</title>
<link rel="stylesheet" href="common.css"/>
<link rel="stylesheet" href="app.min.css"/>
<style>
.wrap{max-width:960px;margin:0 auto;padding:20px 16px}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{border:1px solid #e5e7eb;padding:10px;font-size:.9rem;text-align:left;vertical-align:top}
th{background:#f9fafb}
.actions{display:flex;gap:6px;flex-wrap:wrap}
button{padding:6px 10px;border-radius:8px;border:1px solid #ccc;cursor:pointer;font-size:.85rem}
button.approve{background:#16a34a;color:#fff;border:none}
button.delete{background:#dc2626;color:#fff;border:none}
button.edit{background:#2563eb;color:#fff;border:none}
.error{color:#dc2626;font-size:.9rem;margin-top:10px;text-align:center}
form.editor{margin-top:30px;display:grid;gap:12px;max-width:500px}
form.editor label{font-weight:700}
form.editor input,form.editor textarea{padding:8px;border:1px solid #ddd;border-radius:8px}
@media(max-width:600px){
  table{font-size:.8rem}
  .actions{flex-direction:column}
  button{width:100%}
}
</style>
</head>
<body>
  <main class="wrap">
    <h1>ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
    <p>ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
    <form id="loginForm" style="margin-bottom:30px;display:grid;gap:12px;max-width:400px">
      <input type="email" id="email" placeholder="ì´ë©”ì¼" required/>
      <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required/>
      <button type="submit">ë¡œê·¸ì¸</button>
      <div id="error" class="error"></div>
    </form>

    <section id="adminSection" style="display:none">
      <h2>í”„ë¡œì íŠ¸ ìŠ¹ì¸ & ê´€ë¦¬</h2>
      <table>
        <thead>
          <tr>
            <th>ë²ˆí˜¸</th>
            <th>í”„ë¡œì íŠ¸ëª…</th>
            <th>êµ¬ì¡°ì</th>
            <th>ìš”ì•½</th>
            <th>ì—°ë½ì²˜</th>
            <th>ìƒíƒœ</th>
            <th>ì•¡ì…˜</th>
          </tr>
        </thead>
        <tbody id="projects-body">
          <tr><td colspan="7" class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
        </tbody>
      </table>

      <!-- í”„ë¡œì íŠ¸ í¸ì§‘ ì„¹ì…˜ -->
      <section id="editorSection" style="display:none">
        <h2>í”„ë¡œì íŠ¸ ìˆ˜ì¹˜/ë§í¬ ì—…ë°ì´íŠ¸</h2>
        <form id="editorForm" class="editor">
          <input type="hidden" id="edit-id"/>
          <label>ëª¨ê¸ˆì•¡ (currentAmount)</label>
          <input type="number" id="edit-currentAmount"/>
          <label>ì°¸ì—¬ì ìˆ˜ (supporterCount)</label>
          <input type="number" id="edit-supporterCount"/>
          <label>ëª©í‘œ ê¸ˆì•¡ (goalAmount)</label>
          <input type="number" id="edit-goalAmount"/>
          <label>í•œì¤„ ë©”ì‹œì§€ (keyMessage)</label>
          <input type="text" id="edit-keyMessage"/>
          <label>ì¹´ì¹´ì˜¤í†¡ ì˜¤í”ˆì±„íŒ… ë§í¬</label>
          <input type="url" id="edit-kakaoChatUrl" placeholder="https://open.kakao.com/..."/>
          <button type="submit">ì €ì¥í•˜ê¸°</button>
        </form>
      </section>
    </section>
  </main>

  <script type="module">
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { app } from "./js/firebase.js";
    import { fetchAllProjects, approveProject, deleteProject } from "./js/api.js";

    const auth = getAuth(app);
    const db = getFirestore(app);

    const form = document.getElementById("loginForm");
    const errorDiv = document.getElementById("error");
    const adminSection = document.getElementById("adminSection");
    const $body = document.getElementById("projects-body");
    const editorSection = document.getElementById("editorSection");
    const editorForm = document.getElementById("editorForm");

    async function isAdminUser(uid){
      console.log("ğŸ” ê´€ë¦¬ì ì²´í¬ UID:", uid); // âœ… ë””ë²„ê·¸ ë¡œê·¸
      const docRef = doc(db, "admins", uid);
      const snap = await getDoc(docRef);
      console.log("ğŸ“„ admins ë¬¸ì„œ ì¡´ì¬ ì—¬ë¶€:", snap.exists()); // âœ… ë””ë²„ê·¸ ë¡œê·¸
      return snap.exists();
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      errorDiv.textContent = "";
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        console.log("âœ… ë¡œê·¸ì¸ ì„±ê³µ:", user.email, "UID:", user.uid); // âœ… ë””ë²„ê·¸ ë¡œê·¸
        const ok = await isAdminUser(user.uid);
        if (!ok) { errorDiv.textContent = "âš ï¸ ê´€ë¦¬ì ê¶Œí•œì´ ì—†ëŠ” ê³„ì •ì…ë‹ˆë‹¤."; return; }

        form.style.display = "none";
        adminSection.style.display = "block";
        render();

      } catch (err) {
        console.error("ë¡œê·¸ì¸ ì‹¤íŒ¨:", err);
        errorDiv.textContent = "ë¡œê·¸ì¸ ì‹¤íŒ¨: " + (err.message || "");
      }
    });

    function fmtStatus(p){return p.adminApproved?"ìŠ¹ì¸ë¨ âœ…":"ëŒ€ê¸°ì¤‘ â³"}

    async function render(){
      try{
        const list=await fetchAllProjects();
        if(!list.length){
          $body.innerHTML='<tr><td colspan="7" class="muted">ì•„ì§ ë“±ë¡ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
          return;
        }
        $body.innerHTML=list.map(p=>`
          <tr>
            <td>${p.projectNumber ? `PAW #${p.projectNumber}` : '-'}</td>
            <td>${p.name??'(ì´ë¦„ ì—†ìŒ)'}</td>
            <td>${p.rescuerName??'-'}</td>
            <td>${p.summary??''}</td>
            <td>${p.privateContact??''}</td>
            <td>${fmtStatus(p)}</td>
            <td class="actions">
              ${!p.adminApproved?`<button class="approve" data-id="${p.id}">ìŠ¹ì¸</button>`:''}
              <button class="edit" data-id="${p.id}">í¸ì§‘</button>
              <button class="delete" data-id="${p.id}">ì‚­ì œ</button>
            </td>
          </tr>`).join('');
      }catch(e){
        console.error(e);
        $body.innerHTML='<tr><td colspan="7" class="muted">í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</td></tr>';
      }
    }

    $body.addEventListener('click', async e=>{
      if(e.target.matches('.approve')){
        if(confirm("ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
          await approveProject(e.target.dataset.id);
          alert("ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
          render();
        }
      }
      if(e.target.matches('.delete')){
        if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
          await deleteProject(e.target.dataset.id);
          alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
          render();
        }
      }
      if(e.target.matches('.edit')){
        const id=e.target.dataset.id;
        const all=await fetchAllProjects();
        const p=all.find(x=>x.id===id);
        if(!p)return;
        document.getElementById("edit-id").value=id;
        document.getElementById("edit-currentAmount").value=p.currentAmount||0;
        document.getElementById("edit-supporterCount").value=p.supporterCount||0;
        document.getElementById("edit-goalAmount").value=p.goalAmount||0;
        document.getElementById("edit-keyMessage").value=p.keyMessage||"";
        document.getElementById("edit-kakaoChatUrl").value=p.kakaoChatUrl||"";
        editorSection.style.display="block";
        editorForm.scrollIntoView({behavior:"smooth"});
      }
    });

    editorForm.addEventListener("submit", async e=>{
      e.preventDefault();
      const id=document.getElementById("edit-id").value;
      if(!id)return alert("ì˜ëª»ëœ í”„ë¡œì íŠ¸ ID");

      const data={
        currentAmount: Number(document.getElementById("edit-currentAmount").value)||0,
        supporterCount: Number(document.getElementById("edit-supporterCount").value)||0,
        goalAmount: Number(document.getElementById("edit-goalAmount").value)||0,
        keyMessage: document.getElementById("edit-keyMessage").value.trim(),
        kakaoChatUrl: document.getElementById("edit-kakaoChatUrl").value.trim()
      };

      try{
        await updateDoc(doc(db,"projects",id),data);
        alert("í”„ë¡œì íŠ¸ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
        render();
      }catch(err){
        console.error(err);
        alert("ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: "+err.message);
      }
    });
  </script>
</body>
</html>
