<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>프로젝트 등록</title>
<link rel="stylesheet" href="common.css"/>
<link rel="stylesheet" href="app.min.css"/>
<link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/variable/woff2/SUIT-Variable.css" rel="stylesheet"/>
<style>
  :root{
    --ink:#111;
    --sub:#555;
    --accent:#E87722;
    --line:#eaeaea;
    --bg:#fff;
  }
  body{background:#fafafa;font-family:'SUIT Variable','Pretendard',system-ui,sans-serif;color:var(--ink);margin:0}
  .wrap{max-width:880px;margin:0 auto;padding:30px 16px}
  h1{font-size:2rem;font-weight:900;margin-bottom:24px;color:var(--ink);text-align:center}
  form{display:flex;flex-direction:column;gap:24px}
  .form-section{background:#fff;border-radius:16px;padding:24px 28px;
    box-shadow:0 4px 12px rgba(0,0,0,0.06);border:1px solid var(--line);}
  .form-section h2{font-size:1.2rem;font-weight:800;margin:0 0 14px;color:var(--ink);}
  label{font-weight:700;margin:10px 0 6px;display:block}
  input,textarea{width:100%;padding:12px 14px;border:1px solid #ddd;border-radius:10px;font-size:1rem;line-height:1.4}
  input:focus,textarea:focus{border-color:var(--accent);outline:none;box-shadow:0 0 0 2px rgba(232,119,34,0.2)}
  textarea{min-height:120px;resize:vertical}
  .grid2{display:grid;gap:16px;grid-template-columns:1fr 1fr}
  @media(max-width:760px){.grid2{grid-template-columns:1fr}}
  .note{color:#666;font-size:.85rem;margin-top:4px}
  .guide-box{background:#fdfbf9;border:1px dashed #f2c8a2;border-radius:12px;padding:16px;font-size:.9rem;line-height:1.6;margin-top:12px}
  .guide-box strong{color:var(--accent)}
  .upload-box{border:2px dashed #ddd;border-radius:12px;padding:20px;text-align:center;color:#666;cursor:pointer;transition:.2s}
  .upload-box:hover{border-color:var(--accent);background:#fff7f2;color:var(--accent)}
  .preview{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
  .preview img{width:110px;height:110px;object-fit:cover;border-radius:10px;border:1px solid #ddd}
  .actions{display:flex;gap:12px;justify-content:flex-end}
  .btn{padding:12px 20px;border-radius:10px;font-weight:700;cursor:pointer;text-decoration:none;border:none}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.primary:hover{background:#c85e12}
  .btn.ghost{background:#f5f5f5;color:#444}
</style>
</head>
<body>
  <div data-include="header"></div>

  <main class="wrap">
    <h1>🐾 프로젝트 등록</h1>
    <form id="form">
      <!-- 기존 입력 필드들 그대로 유지 -->
      ... (생략: 기존 form-section 내용은 동일) ...
      <div class="actions">
        <a class="btn ghost" href="index.html">취소</a>
        <button class="btn primary" type="submit" id="submitBtn">등록하기</button>
      </div>
    </form>
  </main>

  <div data-include="footer"></div>

  <script type="module">
    import { injectLayout } from './js/include.js';
    import { apiCreateProject } from './js/api.js';
    import { authReady } from './js/firebase.js';

    injectLayout({ active:'create' });

    const form=document.getElementById('form');
    const submitBtn=document.getElementById('submitBtn');

    const desc=document.getElementById('desc');
    const descCount=document.getElementById('descCount');
    desc.addEventListener('input',()=>{descCount.textContent=desc.value.length;});

    function setupCurrencyInput(el){
      el.addEventListener("input",()=>{
        const raw=el.value.replace(/[^0-9]/g,"");
        if(raw){
          el.value=Number(raw).toLocaleString("ko-KR")+"원";
          el.dataset.value=raw;
        }else{el.value="";el.dataset.value="";}
      });
    }
    setupCurrencyInput(document.getElementById("goalAmount"));
    setupCurrencyInput(document.getElementById("rescuerContribution"));

    function setupPreview(inputId,previewId){
      const input=document.getElementById(inputId);
      const preview=document.getElementById(previewId);
      input.addEventListener('change',()=>{
        preview.innerHTML='';
        [...input.files].forEach((file)=>{
          const reader=new FileReader();
          reader.onload=e=>{
            const div=document.createElement('div');
            div.innerHTML=`<img src="${e.target.result}" alt="preview"/>`;
            preview.appendChild(div);
          };
          reader.readAsDataURL(file);
        });
      });
    }
    setupPreview('repImage','previewRep');
    setupPreview('situationImages','previewSituation');
    setupPreview('receiptImages','previewReceipt');

    form.addEventListener('submit',async(e)=>{
      e.preventDefault();
      await authReady;

      submitBtn.classList.add('disabled');
      submitBtn.textContent='업로드 중...';

      try{
        const fd=new FormData(form);
        const now=Date.now();
        const projectData={
          name:fd.get("name"),
          rescuerName:fd.get("rescuerName"),
          summary:fd.get("summary"),
          description:fd.get("description"),
          goalAmount:document.getElementById("goalAmount").dataset.value||0,
          rescuerContribution:document.getElementById("rescuerContribution").dataset.value||0,
          registrantKakaoId:fd.get("registrantKakaoId"),
          coverFile:document.getElementById('repImage').files[0]||null,
          galleryFiles:Array.from(document.getElementById('situationImages').files),
          receiptFiles:Array.from(document.getElementById('receiptImages').files),

          // 📌 메타데이터
          createdAt: now,
          updatedAt: now,
          status: "pending",
          approvedAt: null
        };
        const savedId=await apiCreateProject(projectData);
        location.href='project.html?id='+encodeURIComponent(savedId);
      }catch(err){
        alert('업로드 실패: '+(err.message||'')); 
      }finally{
        submitBtn.classList.remove('disabled');
        submitBtn.textContent='등록하기';
      }
    });
  </script>
</body>
</html>
