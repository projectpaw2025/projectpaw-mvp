<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>í”„ë¡œì íŠ¸ ë“±ë¡</title>
<link rel="stylesheet" href="common.css"/>
<link rel="stylesheet" href="app.min.css"/>
<style>
.wrap{max-width:860px;margin:0 auto;padding:20px 16px}
form{display:grid;gap:12px}
label{font-weight:800;margin-top:6px}
input,textarea{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px}
textarea{min-height:120px;resize:vertical}
.grid2{display:grid;gap:12px;grid-template-columns:1fr 1fr}
@media(max-width:760px){.grid2{grid-template-columns:1fr}}
.note{color:#6b7280;font-size:.85rem}
.actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
.disabled{opacity:.6;pointer-events:none}
/* ì‘ì„± ê°€ì´ë“œ */
.guide-box{
  background:#f9fafb;
  border:1px dashed #d1d5db;
  border-radius:12px;
  padding:16px;
  font-size:.9rem;
  line-height:1.5;
  margin-bottom:10px;
}
/* ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° */
.preview{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
.preview-item{position:relative}
.preview img{width:100px;height:100px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb}
.remove-btn{
  position:absolute;top:4px;right:4px;
  background:rgba(0,0,0,0.6);color:#fff;
  border:none;border-radius:50%;width:22px;height:22px;
  font-size:.8rem;cursor:pointer;line-height:1;
}
</style>
</head>
<body>
  <div data-include="header"></div>

  <main class="wrap">
    <h1 style="margin:0 0 6px">í”„ë¡œì íŠ¸ ë“±ë¡</h1>
    <form id="form">
      <div class="grid2">
        <div><label>ë™ë¬¼ ì´ë¦„</label><input name="name" required/></div>
        <div><label>êµ¬ì¡°ì ì´ë¦„</label><input name="rescuerName" required/></div>
      </div>
      <div><label>ìƒí™© ìš”ì•½</label><input name="summary" required/></div>

      <!-- ì‘ì„± ê°€ì´ë“œ -->
      <div class="guide-box">
        âœï¸ <strong>ì‘ì„± ê°€ì´ë“œ</strong><br/>
        â€¢ ğŸ¾ êµ¬ì¡° ë™ë¬¼ ì†Œê°œ (ì–¸ì œ, ì–´ë””ì„œ ë°œê²¬ë˜ì—ˆë‚˜ìš”?)<br/>
        â€¢ ğŸ’” í˜„ì¬ ìƒí™© (ì¹˜ë£Œ/ì„ì‹œë³´í˜¸ í˜„í™©)<br/>
        â€¢ ğŸ¯ ëª©í‘œ (í›„ì›ê¸ˆ ì‚¬ìš© ê³„íš)<br/>
        â€¢ ğŸ™ ë¶€íƒì˜ ë§ (í›„ì›ìì—ê²Œ í•˜ê³  ì‹¶ì€ ë©”ì‹œì§€)
      </div>

      <div>
        <label>ìƒì„¸ ì„¤ëª…</label>
        <textarea name="description" id="desc" maxlength="500" required></textarea>
        <div class="note"><span id="descCount">0</span> / 500ì</div>
      </div>

      <div class="grid2">
        <div><label>ëª©í‘œ ê¸ˆì•¡(ì›)</label><input type="number" name="goalAmount" min="0" required/></div>
        <div><label>êµ¬ì¡°ì ë¶€ë‹´ì•¡(ì›)</label><input type="number" name="rescuerContribution" min="0" required/></div>
      </div>
      <div><label>ë“±ë¡ì ì¹´ì¹´ì˜¤í†¡ ID</label><input name="registrantKakaoId" required/></div>

      <div>
        <label>ëŒ€í‘œ ì‚¬ì§„ (1ì¥)</label>
        <input type="file" id="repImage" accept="image/*" required/>
        <div class="preview" id="previewRep"></div>
      </div>

      <div>
        <label>êµ¬ì¡° ìƒí™© ì‚¬ì§„ (ì—¬ëŸ¬ ì¥)</label>
        <input type="file" id="situationImages" accept="image/*" multiple/>
        <div class="preview" id="previewSituation"></div>
      </div>

      <div>
        <label>ì˜ìˆ˜ì¦ ì‚¬ì§„ (ì—¬ëŸ¬ ì¥)</label>
        <input type="file" id="receiptImages" accept="image/*" multiple/>
        <div class="preview" id="previewReceipt"></div>
      </div>

      <p class="note">* ë³‘ì›ëª…/ê³„ì¢Œ/ì¹´ì¹´ì˜¤í†¡ ì´ˆëŒ€ë§í¬ëŠ” <b>ê´€ë¦¬ì ì „ìš©</b> í™”ë©´ì—ì„œ ë“±ë¡ë©ë‹ˆë‹¤.</p>
      <div class="actions">
        <a class="btn ghost" href="index.html">ì·¨ì†Œ</a>
        <button class="btn primary" type="submit" id="submitBtn">ë“±ë¡í•˜ê¸°</button>
      </div>
    </form>
  </main>

  <div data-include="footer"></div>

  <script type="module">
    import { injectLayout } from './js/include.js';
    import { apiCreateProject } from './js/api.js';
    import { authReady } from './js/firebase.js';

    injectLayout({ active:'create' });

    const form = document.getElementById('form');
    const submitBtn = document.getElementById('submitBtn');

    // ê¸€ì ìˆ˜ ì¹´ìš´í„°
    const desc = document.getElementById('desc');
    const descCount = document.getElementById('descCount');
    desc.addEventListener('input', ()=>{
      descCount.textContent = desc.value.length;
    });

    // ë¯¸ë¦¬ë³´ê¸° + ì‚­ì œ ê¸°ëŠ¥
    function setupPreview(inputId, previewId){
      const input = document.getElementById(inputId);
      const preview = document.getElementById(previewId);

      input.addEventListener('change', ()=>{
        preview.innerHTML = '';
        [...input.files].forEach((file,idx)=>{
          const reader = new FileReader();
          reader.onload = e=>{
            const div = document.createElement('div');
            div.className = 'preview-item';
            div.innerHTML = `
              <img src="${e.target.result}" alt="preview"/>
              <button type="button" class="remove-btn">&times;</button>
            `;
            div.querySelector('.remove-btn').addEventListener('click', ()=>{
              const dt = new DataTransfer();
              [...input.files].forEach((f,i)=>{ if(i!==idx) dt.items.add(f); });
              input.files = dt.files;
              div.remove();
            });
            preview.appendChild(div);
          };
          reader.readAsDataURL(file);
        });
      });
    }
    setupPreview('repImage','previewRep');
    setupPreview('situationImages','previewSituation');
    setupPreview('receiptImages','previewReceipt');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      await authReady;

      submitBtn.classList.add('disabled');
      submitBtn.textContent = 'ì—…ë¡œë“œ ì¤‘...';

      try {
        const fd = new FormData(form);

        const projectData = {
          name: fd.get("name"),
          rescuerName: fd.get("rescuerName"),
          summary: fd.get("summary"),
          description: fd.get("description"),
          goalAmount: fd.get("goalAmount"),
          rescuerContribution: fd.get("rescuerContribution"),
          registrantKakaoId: fd.get("registrantKakaoId"),
          coverFile: document.getElementById('repImage').files[0] || null,
          galleryFiles: Array.from(document.getElementById('situationImages').files),
          receiptFiles: Array.from(document.getElementById('receiptImages').files)
        };

        const savedId = await apiCreateProject(projectData);
        location.href = 'project.html?id=' + encodeURIComponent(savedId);

      } catch (err) {
        alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (err.message || ''));
      } finally {
        submitBtn.classList.remove('disabled');
        submitBtn.textContent = 'ë“±ë¡í•˜ê¸°';
      }
    });
  </script>
</body>
</html>
