<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>í”„ë¡œì íŠ¸ ë“±ë¡ â€” Project.PAW</title>
  <link rel="stylesheet" href="common.css"/>
  <link rel="stylesheet" href="app.min.css"/>
  <style>
    .container-narrow { max-width: 880px; margin: 0 auto; padding: 0 16px; }
    .section-title { font-size: 1.5rem; margin: 8px 0 16px; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .form-grid .full { grid-column: 1 / -1; }
    label { display:block; font-weight:600; margin-bottom:6px; }
    input, textarea { width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:8px; }
    input:disabled { background:#f3f4f6; color:#9ca3af; } /* ìŒì˜ */
    .btn { padding:10px 14px; border-radius:10px; border:1px solid #111; background:#111; color:#fff; cursor:pointer; }
    .btn.secondary { background:#fff; color:#111; border:1px solid #ddd; }
    .hint { font-size:.85rem; color:#6b7280; }
  </style>
</head>
<body>
  <div data-include="header"></div>

  <main class="container-narrow" style="padding:24px 0">
    <h2 class="section-title">í”„ë¡œì íŠ¸ ë“±ë¡</h2>
    <form id="form" class="form-grid">
      <div>
        <label>ë™ë¬¼ ì´ë¦„</label>
        <input name="name" type="text" placeholder="ì˜ˆ: ë‚˜ë¹„" required/>
      </div>
      <div>
        <label>êµ¬ì¡°ì ì´ë¦„</label>
        <input name="rescuerName" type="text" placeholder="ì˜ˆ: í™ê¸¸ë™" required/>
      </div>

      <div class="full">
        <label>ìƒí™© ìš”ì•½</label>
        <input name="summary" type="text" placeholder="ì§§ì€ í•œ ì¤„ ìš”ì•½" required/>
      </div>

      <div class="full">
        <label>ìƒì„¸ ì„¤ëª…</label>
        <textarea name="description" rows="6" placeholder="ë¬´ìŠ¨ ì¼ì´ ìˆì—ˆëŠ”ì§€, í•„ìš”í•œ ì¹˜ë£Œì™€ ë¹„ìš© ë“±ì„ ì ì–´ì£¼ì„¸ìš”." required></textarea>
      </div>

      <div>
        <label>ëª©í‘œ ê¸ˆì•¡(ì›)</label>
        <input name="goalAmount" type="number" min="0" step="1000" placeholder="ì˜ˆ: 600000" required/>
      </div>
      <div>
        <label>êµ¬ì¡°ì ë¶€ë‹´ì•¡(ì›)</label>
        <input name="rescuerContribution" type="number" min="0" step="1000" placeholder="ì˜ˆ: 180000" required/>
      </div>

      <!-- ğŸ”¥ Beta Service ë¹„í™œì„±í™” í•„ë“œ -->
      <div>
        <label>ë™ë¬¼ë³‘ì› ì´ë¦„</label>
        <input name="hospitalName" type="text" placeholder="Beta Service í›„ í™œì„±í™” ì˜ˆì •" disabled/>
      </div>
      <div>
        <label>ê³„ì¢Œë²ˆí˜¸(ì°¸ê³ )</label>
        <input name="bankAccount" type="text" placeholder="Beta Service í›„ í™œì„±í™” ì˜ˆì •" disabled/>
      </div>
      <div class="full">
        <label>ì¹´ì¹´ì˜¤í†¡ ì´ˆëŒ€ë§í¬</label>
        <input name="kakaoInviteLink" type="url" placeholder="Beta Service í›„ í™œì„±í™” ì˜ˆì •" disabled/>
      </div>

      <!-- ğŸ”¥ ë“±ë¡ì ì¹´ì¹´ì˜¤í†¡ ID -->
      <div class="full">
        <label>ë“±ë¡ì ì¹´ì¹´ì˜¤í†¡ ID</label>
        <input name="registrantKakaoId" type="text" placeholder="ìš´ì˜ì ê²€ì¦ì„ ìœ„í•´ ì¹´ì¹´ì˜¤í†¡ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”" required/>
      </div>

      <div class="full">
        <label>ëŒ€í‘œ ì‚¬ì§„ (1ì¥)</label>
        <input id="repImage" type="file" accept="image/*" required/>
      </div>
      <div class="full">
        <label>êµ¬ì¡° ìƒí™© ì‚¬ì§„ (ì—¬ëŸ¬ ì¥)</label>
        <input id="situationImages" type="file" accept="image/*" multiple/>
      </div>
      <div class="full">
        <label>ì˜ìˆ˜ì¦ ì‚¬ì§„ (ì—¬ëŸ¬ ì¥)</label>
        <input id="receiptImages" type="file" accept="image/*" multiple/>
      </div>

      <div class="full" style="display:flex; gap:8px; justify-content:flex-end">
        <a class="btn secondary" href="index.html">ì·¨ì†Œ</a>
        <button class="btn" type="submit">ë“±ë¡í•˜ê¸°</button>
      </div>
    </form>
  </main>

  <div data-include="footer"></div>

  <script type="module">
    import { injectLayout } from "./js/include.js";
    injectLayout({ active: "create" });
  </script>

  <script src="paw.js"></script>

  <script>
    (function () {
      if (typeof window.parseFilesToDataURLs !== "function") {
        window.parseFilesToDataURLs = async function (fileList) {
          const files = Array.from(fileList || []);
          const toDataURL = (file) =>
            new Promise((res, rej) => {
              const reader = new FileReader();
              reader.onload = () => res(reader.result);
              reader.onerror = rej;
              reader.readAsDataURL(file);
            });
          const results = [];
          for (const f of files) results.push(await toDataURL(f));
          return results;
        };
      }
      if (typeof window.upsertProject !== "function") {
        window.upsertProject = function (p) {
          try {
            const key = "projects";
            const raw = localStorage.getItem(key);
            const arr = Array.isArray(JSON.parse(raw)) ? JSON.parse(raw) : [];
            const idx = arr.findIndex((x) => x.id === p.id);
            if (idx >= 0) arr[idx] = p;
            else arr.push(p);
            localStorage.setItem(key, JSON.stringify(arr));
          } catch (e) {
            console.error("upsertProject ì‹¤íŒ¨:", e);
            alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
          }
        };
      }

      const form = document.getElementById("form");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const fd = new FormData(form);
        const repFile = document.querySelector("#repImage").files[0];
        const situationFiles = document.querySelector("#situationImages").files;
        const receiptFiles = document.querySelector("#receiptImages").files;

        const repData = repFile ? (await window.parseFilesToDataURLs([repFile]))[0] : null;
        const situationData = await window.parseFilesToDataURLs(situationFiles);
        const receiptData = await window.parseFilesToDataURLs(receiptFiles);

        const p = {
          id: Date.now().toString(),
          createdAt: Date.now(),

          name: fd.get("name"),
          rescuerName: fd.get("rescuerName"),
          summary: fd.get("summary"),
          description: fd.get("description"),

          goalAmount: Number(fd.get("goalAmount") || 0),
          rescuerContribution: Number(fd.get("rescuerContribution") || 0),

          hospitalName: null, // Beta ë‹¨ê³„ â†’ null ì²˜ë¦¬
          bankAccount: null,
          kakaoInviteLink: null,

          registrantKakaoId: fd.get("registrantKakaoId"),

          representativeImage: repData,
          gallery: situationData,
          receipts: receiptData,

          raisedAmount: 0,
          adminApproved: false
        };

        window.upsertProject(p);
        location.href = "project.html?id=" + encodeURIComponent(p.id);
      });
    })();
  </script>
</body>
</html>
