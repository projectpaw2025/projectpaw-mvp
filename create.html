<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>후원 등록 · Project.PAW</title>
  <meta name="description" content="책임 기반 구조 원칙에 따라 프로젝트를 등록해주세요. 대표/상황/영수증 사진과 카카오 링크를 포함할 수 있습니다." />
  <link rel="icon" href="img/placeholder.svg" />
  <link rel="stylesheet" href="css/app.css" />
</head>
<body>
  <nav class="nav">
    <div class="container">
      <div class="brand"><a href="index.html">Project<span class="dot">.PAW</span></a></div>
      <ul>
        <li><a href="index.html">홈</a></li>
        <li><a href="project_list.html">후원하기</a></li>
        <li><a href="create.html" class="btn">후원 등록</a></li>
      </ul>
    </div>
  </nav>

  <main class="container">
    <section class="section">
      <h2>후원 등록</h2>
      <p style="color:#445;">실제 사례만 등록해주세요. <b>구조자 30% 자부담</b>과 <b>영수증/후기 공개</b>가 원칙입니다.</p>

      <div class="form">
        <label class="title">프로젝트명 / 고양이 이름</label>
        <input id="title" class="input" placeholder="예: 나비 – 교통사고 치료비" />

        <label class="title">상황 요약 (한 줄)</label>
        <input id="summary" class="input" placeholder="예: 수술비 60만원 중 40만원 모금 요청" />

        <label class="title">상세 설명</label>
        <textarea id="description" placeholder="상세 상황과 필요한 치료/비용을 적어주세요. 후기 공개를 약속합니다."></textarea>

        <div class="grid-2">
          <div>
            <label class="title">목표 금액 (원)</label>
            <input id="target" type="number" class="input" placeholder="예: 400000" />
          </div>
          <div>
            <label class="title">구조자 부담금 (원)</label>
            <input id="selfpay" type="number" class="input" placeholder="예: 200000" />
          </div>
        </div>

        <label class="title">카카오톡 연결 링크</label>
        <input id="kakao" class="input" placeholder="https://open.kakao.com/o/..." />

        <div class="switch">
          <input id="status" type="checkbox">
          <span>관리자 승인</span>
        </div>

        <label class="title">대표 이미지</label>
        <input id="cover" type="file" accept="image/*" class="input"/>
        <div class="img-preview"><img id="coverPreview" alt="대표 미리보기" /></div>

        <label class="title">상황 사진 (여러 장)</label>
        <input id="gallery" type="file" accept="image/*" multiple class="input"/>
        <div class="gallery-preview grid"></div>

        <label class="title">영수증 사진 (여러 장)</label>
        <input id="receipts" type="file" accept="image/*" multiple class="input"/>
        <div class="receipt-preview grid"></div>

        <div>
          <button id="saveBtn" class="btn primary">등록하기</button>
        </div>
      </div>
    </section>

    <!-- ✅ 수정된 스크립트 -->
    <script type="module">
      import { SCHEMA, storage as dbStorage, uid } from "./js/app.js";
      import { toast } from "./js/utils.js";
      import "./js/uploader.js";
      import { uploadFile } from "./js/uploader.js";
      import { authReady, auth } from "./js/firebase.js";

      const $ = s => document.querySelector(s);

      $("#saveBtn").addEventListener("click", async (e) => {
        e.preventDefault();

        // ✅ 익명 로그인 완료까지 대기
        await authReady;
        console.log("[auth] currentUser:", auth.currentUser?.uid);

        const data = structuredClone(SCHEMA);
        data.id = uid();
        data.title = $("#title").value.trim();
        data.summary = $("#summary").value.trim();
        data.description = $("#description").value.trim();
        data.targetAmount = Number($("#target").value || 0);
        data.selfPayAmount = Number($("#selfpay").value || 0);
        data.kakaoLink = $("#kakao").value.trim();
        data.status = $("#status").checked ? "approved" : "pending";
        data.createdAt = Date.now();

        if (!data.title || !data.summary) {
          toast("프로젝트명과 요약을 입력해주세요."); 
          return;
        }

        const coverFile = $("#cover")?.files?.[0];
        const galleryFiles = Array.from($("#gallery")?.files || []);
        const receiptFiles = Array.from($("#receipts")?.files || []);

        try {
          if (coverFile) data.images.cover = await uploadFile("covers", coverFile);
          data.images.gallery = [];
          for (const f of galleryFiles) data.images.gallery.push(await uploadFile("gallery", f));
          data.images.receipts = [];
          for (const f of receiptFiles) data.images.receipts.push(await uploadFile("receipts", f));
        } catch (err) {
          console.error(err);
          toast("이미지 업로드 실패. 다시 시도해주세요.");
          return;
        }

        try {
          await dbStorage.add(data);
          toast("등록 완료! 홈으로 이동합니다.");
          location.href = "index.html";
        } catch (err) {
          console.error(err);
          toast("등록 실패. 잠시 후 다시 시도해주세요.");
        }
      });
    </script>
  </main>

  <footer class="footer">
    <div class="container">
      <small>Project.PAW — “도움은 본능, 연결은 선택.” 100% 전달 · 책임 구조 · 직접 연결</small>
    </div>
  </footer>
</body>
</html>
