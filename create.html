<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Project.PAW — 후원 등록</title>
  <link rel="stylesheet" href="css/app.css" />
  <meta name="description" content="Project.PAW 프로젝트 등록" />
  <link rel="icon" href="img/favicon.ico" />
</head>
<body>
  <header>
    <nav class="navbar">
      <a href="index.html" class="logo">Project.<strong>PAW</strong></a>
      <ul class="nav-links">
        <li><a href="index.html">홈</a></li>
        <li><a href="project_list.html">후원하기</a></li>
        <li><a href="create.html" class="active">후원 등록</a></li>
      </ul>
    </nav>
  </header>

  <main class="container">
    <h1>후원 등록</h1>

    <form id="createForm" class="form">
      <label>프로젝트 제목
        <input id="title" type="text" placeholder="예) 병원비가 급한 콩이" required />
      </label>

      <label>요약 설명
        <input id="summary" type="text" placeholder="한 줄 요약을 적어주세요" required />
      </label>

      <label>상세 설명
        <textarea id="description" rows="6" placeholder="상세한 상황을 적어주세요"></textarea>
      </label>

      <label>목표 금액
        <input id="target" type="number" min="0" step="1000" placeholder="1000000" />
      </label>

      <label>자부담 금액
        <input id="selfpay" type="number" min="0" step="1000" placeholder="300000" />
      </label>

      <label>카카오톡 링크
        <input id="kakao" type="url" placeholder="https://open.kakao.com/..." />
      </label>

      <label class="checkbox">
        <input id="status" type="checkbox" />
        <span>관리자 승인(노출 허용)</span>
      </label>

      <label>대표 이미지
        <input id="cover" type="file" accept="image/*" />
      </label>

      <label>상황 사진 (여러 장)
        <input id="gallery" type="file" accept="image/*" multiple />
      </label>

      <label>영수증 사진 (여러 장)
        <input id="receipts" type="file" accept="image/*" multiple />
      </label>

      <button id="saveBtn" type="button" class="btn primary">등록하기</button>
    </form>
  </main>

  <footer>
    <small>Project.<strong>PAW</strong> — 도움은 본능, 연결은 선택.</small>
  </footer>

  <!-- ✅ 수정된 스크립트 -->
  <script type="module">
    import { SCHEMA, storage as dbStorage, uid } from "./js/app.js";
    import { toast } from "./js/utils.js";
    import { uploadFile } from "./js/uploader.js";
    import { authReady, auth } from "./js/firebase.js";

    const $ = (s) => document.querySelector(s);

    // 등록 버튼 이벤트
    $("#saveBtn").addEventListener("click", async (e) => {
      e.preventDefault();

      // ✅ 업로드/쓰기 전에 인증 완료 기다림
      await authReady;
      console.log("[auth] currentUser:", auth.currentUser?.uid);

      const data = structuredClone(SCHEMA);
      data.id = uid();
      data.title = $("#title").value.trim();
      data.summary = $("#summary").value.trim();
      data.description = $("#description").value.trim();
      data.targetAmount = Number($("#target").value || 0);
      data.selfPayAmount = Number($("#selfpay").value || 0);
      data.kakaoLink = $("#kakao").value.trim();
      data.status = $("#status").checked ? "approved" : "pending";
      data.createdAt = Date.now();

      if (!data.title || !data.summary) {
        toast("프로젝트명과 요약을 입력해주세요.");
        return;
      }

      const coverFile = $("#cover")?.files?.[0];
      const galleryFiles = Array.from($("#gallery")?.files || []);
      const receiptFiles = Array.from($("#receipts")?.files || []);

      try {
        if (coverFile) data.images.cover = await uploadFile("covers", coverFile);
        data.images.gallery = [];
        for (const f of galleryFiles) {
          data.images.gallery.push(await uploadFile("gallery", f));
        }
        data.images.receipts = [];
        for (const f of receiptFiles) {
          data.images.receipts.push(await uploadFile("receipts", f));
        }
      } catch (err) {
        console.error("[upload] failed:", err);
        toast("이미지 업로드 실패(네트워크/권한). 다시 시도해주세요.");
        return;
      }

      try {
        await dbStorage.add(data);
        toast("등록 완료! 홈으로 이동합니다.");
        location.href = "index.html";
      } catch (err) {
        console.error("[firestore] write failed:", err);
        toast("등록 실패(데이터 저장). 잠시 후 다시 시도해주세요.");
      }
    });
  </script>
</body>
</html>
