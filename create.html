<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>프로젝트 등록</title>
<link rel="stylesheet" href="common.css"/>
<link rel="stylesheet" href="app.min.css"/>
<style>
.wrap{max-width:860px;margin:0 auto;padding:20px 16px}
form{display:grid;gap:12px}
label{font-weight:800;margin-top:6px}
input,textarea{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px}
textarea{min-height:120px;resize:vertical}
.grid2{display:grid;gap:12px;grid-template-columns:1fr 1fr}
@media(max-width:760px){.grid2{grid-template-columns:1fr}}
.note{color:#6b7280;font-size:.85rem}
.actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
.disabled{opacity:.6;pointer-events:none}
/* 작성 가이드 */
.guide-box{
  background:#f9fafb;
  border:1px dashed #d1d5db;
  border-radius:12px;
  padding:16px;
  font-size:.9rem;
  line-height:1.5;
  margin-bottom:10px;
}
/* 사진 미리보기 */
.preview{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
.preview-item{position:relative}
.preview img{width:100px;height:100px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb}
.remove-btn{
  position:absolute;top:4px;right:4px;
  background:rgba(0,0,0,0.6);color:#fff;
  border:none;border-radius:50%;width:22px;height:22px;
  font-size:.8rem;cursor:pointer;line-height:1;
}
</style>
</head>
<body>
  <div data-include="header"></div>

  <main class="wrap">
    <h1 style="margin:0 0 6px">프로젝트 등록</h1>
    <form id="form">
      <div class="grid2">
        <div><label>동물 이름</label><input name="name" required/></div>
        <div><label>구조자 이름</label><input name="rescuerName" required/></div>
      </div>
      <div><label>상황 요약</label><input name="summary" required/></div>

      <!-- 작성 가이드 -->
      <div class="guide-box">
        ✍️ <strong>작성 가이드</strong><br/>
        • 🐾 구조 동물 소개 (언제, 어디서 발견되었나요?)<br/>
        • 💔 현재 상황 (치료/임시보호 현황)<br/>
        • 🎯 목표 (후원금 사용 계획)<br/>
        • 🙏 부탁의 말 (후원자에게 하고 싶은 메시지)
      </div>

      <div>
        <label>상세 설명</label>
        <textarea name="description" id="desc" maxlength="500" required></textarea>
        <div class="note"><span id="descCount">0</span> / 500자</div>
      </div>

      <div class="grid2">
        <div><label>목표 금액(원)</label><input type="number" name="goalAmount" min="0" required/></div>
        <div><label>구조자 부담액(원)</label><input type="number" name="rescuerContribution" min="0" required/></div>
      </div>
      <div><label>등록자 카카오톡 ID</label><input name="registrantKakaoId" required/></div>

      <div>
        <label>대표 사진 (1장)</label>
        <input type="file" id="repImage" accept="image/*" required/>
        <div class="preview" id="previewRep"></div>
      </div>

      <div>
        <label>구조 상황 사진 (여러 장)</label>
        <input type="file" id="situationImages" accept="image/*" multiple/>
        <div class="preview" id="previewSituation"></div>
      </div>

      <div>
        <label>영수증 사진 (여러 장)</label>
        <input type="file" id="receiptImages" accept="image/*" multiple/>
        <div class="preview" id="previewReceipt"></div>
      </div>

      <p class="note">* 병원명/계좌/카카오톡 초대링크는 <b>관리자 전용</b> 화면에서 등록됩니다.</p>
      <div class="actions">
        <a class="btn ghost" href="index.html">취소</a>
        <button class="btn primary" type="submit" id="submitBtn">등록하기</button>
      </div>
    </form>
  </main>

  <div data-include="footer"></div>

  <script type="module">
    import { injectLayout } from './js/include.js';
    import { apiCreateProject } from './js/api.js';
    import { authReady } from './js/firebase.js';

    injectLayout({ active:'create' });

    const form = document.getElementById('form');
    const submitBtn = document.getElementById('submitBtn');

    // 글자 수 카운터
    const desc = document.getElementById('desc');
    const descCount = document.getElementById('descCount');
    desc.addEventListener('input', ()=>{
      descCount.textContent = desc.value.length;
    });

    // 미리보기 + 삭제 기능
    function setupPreview(inputId, previewId){
      const input = document.getElementById(inputId);
      const preview = document.getElementById(previewId);

      input.addEventListener('change', ()=>{
        preview.innerHTML = '';
        [...input.files].forEach((file,idx)=>{
          const reader = new FileReader();
          reader.onload = e=>{
            const div = document.createElement('div');
            div.className = 'preview-item';
            div.innerHTML = `
              <img src="${e.target.result}" alt="preview"/>
              <button type="button" class="remove-btn">&times;</button>
            `;
            div.querySelector('.remove-btn').addEventListener('click', ()=>{
              const dt = new DataTransfer();
              [...input.files].forEach((f,i)=>{ if(i!==idx) dt.items.add(f); });
              input.files = dt.files;
              div.remove();
            });
            preview.appendChild(div);
          };
          reader.readAsDataURL(file);
        });
      });
    }
    setupPreview('repImage','previewRep');
    setupPreview('situationImages','previewSituation');
    setupPreview('receiptImages','previewReceipt');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      await authReady;

      submitBtn.classList.add('disabled');
      submitBtn.textContent = '업로드 중...';

      try {
        const fd = new FormData(form);

        const projectData = {
          name: fd.get("name"),
          rescuerName: fd.get("rescuerName"),
          summary: fd.get("summary"),
          description: fd.get("description"),
          goalAmount: fd.get("goalAmount"),
          rescuerContribution: fd.get("rescuerContribution"),
          registrantKakaoId: fd.get("registrantKakaoId"),
          coverFile: document.getElementById('repImage').files[0] || null,
          galleryFiles: Array.from(document.getElementById('situationImages').files),
          receiptFiles: Array.from(document.getElementById('receiptImages').files)
        };

        const savedId = await apiCreateProject(projectData);
        location.href = 'project.html?id=' + encodeURIComponent(savedId);

      } catch (err) {
        alert('업로드 실패: ' + (err.message || ''));
      } finally {
        submitBtn.classList.remove('disabled');
        submitBtn.textContent = '등록하기';
      }
    });
  </script>
</body>
</html>
