<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>프로젝트 등록</title>
<link rel="stylesheet" href="common.css"/>
<link rel="stylesheet" href="app.min.css"/>
<style>
  body{background:#fafafa;font-family:'Inter','SUIT','Pretendard',system-ui,sans-serif;color:#111;margin:0}
  .wrap{max-width:880px;margin:0 auto;padding:30px 16px}

  h1{font-size:2rem;font-weight:900;margin-bottom:24px;color:#A47864;text-align:center}

  form{display:flex;flex-direction:column;gap:24px}

  /* 카드형 섹션 */
  .form-section{
    background:#fff;
    border-radius:16px;
    padding:24px 28px;
    box-shadow:0 4px 12px rgba(0,0,0,0.06);
    border:1px solid #eee;
  }
  .form-section h2{
    font-size:1.2rem;
    font-weight:800;
    margin:0 0 14px;
    color:#A47864;
  }

  label{font-weight:700;margin:10px 0 6px;display:block}
  input,textarea{
    width:100%;padding:12px 14px;
    border:1px solid #ddd;border-radius:10px;
    font-size:1rem;line-height:1.4
  }
  input:focus,textarea:focus{border-color:#A47864;outline:none;box-shadow:0 0 0 2px rgba(164,120,100,0.2)}
  textarea{min-height:120px;resize:vertical}

  .grid2{display:grid;gap:16px;grid-template-columns:1fr 1fr}
  @media(max-width:760px){.grid2{grid-template-columns:1fr}}

  .note{color:#666;font-size:.85rem;margin-top:4px}

  /* 작성 가이드 */
  .guide-box{
    background:#fdfbf9;
    border:1px dashed #e5d4c7;
    border-radius:12px;
    padding:16px;
    font-size:.9rem;
    line-height:1.6;
    margin-top:12px;
  }
  .guide-box strong{color:#A47864}

  /* 업로드 영역 */
  .upload-box{
    border:2px dashed #ddd;
    border-radius:12px;
    padding:20px;
    text-align:center;
    color:#666;
    cursor:pointer;
    transition:.2s;
  }
  .upload-box:hover{border-color:#A47864;background:#faf7f5;color:#A47864}
  .preview{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
  .preview img{width:110px;height:110px;object-fit:cover;border-radius:10px;border:1px solid #ddd}

  .actions{display:flex;gap:12px;justify-content:flex-end}
  .btn{padding:12px 20px;border-radius:10px;font-weight:700;cursor:pointer;text-decoration:none;border:none}
  .btn.primary{background:#A47864;color:#fff}
  .btn.primary:hover{background:#8c6250}
  .btn.ghost{background:#f5f5f5;color:#444}
</style>
</head>
<body>
  <div data-include="header"></div>

  <main class="wrap">
    <h1>🐾 프로젝트 등록</h1>
    <form id="form">

      <!-- 동물 & 구조자 -->
      <div class="form-section">
        <h2>1. 기본 정보</h2>
        <div class="grid2">
          <div>
            <label>동물 이름</label>
            <input name="name" placeholder="예: 초코" required/>
            <div class="note">구조한 동물의 이름이나 별칭</div>
          </div>
          <div>
            <label>구조자 이름</label>
            <input name="rescuerName" placeholder="예: 김철수" required/>
            <div class="note">본인의 이름이나 닉네임</div>
          </div>
        </div>
      </div>

      <!-- 요약 & 설명 -->
      <div class="form-section">
        <h2>2. 프로젝트 소개</h2>
        <label>상황 요약</label>
        <input name="summary" placeholder="예: 교통사고로 다친 강아지 치료비 모금" required/>
        <div class="note">한 줄 요약은 목록에 표시됩니다.</div>

        <div class="guide-box">
          ✍️ <strong>작성 가이드</strong><br/>
          • 🐾 구조 동물 소개 (언제, 어디서 발견되었나요?)<br/>
          • 💔 현재 상황 (치료/임시보호 현황)<br/>
          • 🎯 목표 (후원금 사용 계획)<br/>
          • 🙏 부탁의 말 (후원자에게 하고 싶은 메시지)
        </div>

        <label>상세 설명</label>
        <textarea name="description" id="desc" maxlength="500" required></textarea>
        <div class="note"><span id="descCount">0</span> / 500자</div>
      </div>

      <!-- 금액 -->
      <div class="form-section">
        <h2>3. 목표 금액</h2>
        <div class="grid2">
          <div>
            <label>목표 금액</label>
            <input type="text" id="goalAmount" placeholder="예: 500,000원" required/>
            <div class="note">동물 치료·돌봄에 필요한 금액</div>
          </div>
          <div>
            <label>구조자 부담액</label>
            <input type="text" id="rescuerContribution" placeholder="예: 100,000원" required/>
            <div class="note">구조자가 직접 부담하는 금액</div>
          </div>
        </div>
      </div>

      <!-- 소통 -->
      <div class="form-section">
        <h2>4. 소통 정보</h2>
        <label>등록자 카카오톡 ID</label>
        <input name="registrantKakaoId" placeholder="예: g123abcd" required/>
        <div class="note">후원자와 연결할 오픈채팅방 ID</div>
      </div>

      <!-- 이미지 -->
      <div class="form-section">
        <h2>5. 사진 업로드</h2>

        <label>대표 사진 (1장)</label>
        <input type="file" id="repImage" accept="image/*" required class="upload-box"/>
        <div class="preview" id="previewRep"></div>

        <label>구조 상황 사진 (여러 장)</label>
        <input type="file" id="situationImages" accept="image/*" multiple class="upload-box"/>
        <div class="preview" id="previewSituation"></div>

        <label>영수증 사진 (여러 장)</label>
        <input type="file" id="receiptImages" accept="image/*" multiple class="upload-box"/>
        <div class="note">진료비·치료비 증빙용 영수증을 첨부해주세요.</div>
        <div class="preview" id="previewReceipt"></div>
      </div>

      <p class="note">* 병원명/계좌/카카오톡 초대링크는 <b>관리자 전용</b> 화면에서 등록됩니다.</p>

      <div class="actions">
        <a class="btn ghost" href="index.html">취소</a>
        <button class="btn primary" type="submit" id="submitBtn">등록하기</button>
      </div>
    </form>
  </main>

  <div data-include="footer"></div>

  <script type="module">
    import { injectLayout } from './js/include.js';
    import { apiCreateProject } from './js/api.js';
    import { authReady } from './js/firebase.js';

    injectLayout({ active:'create' });

    const form = document.getElementById('form');
    const submitBtn = document.getElementById('submitBtn');

    // 글자 수 카운터
    const desc = document.getElementById('desc');
    const descCount = document.getElementById('descCount');
    desc.addEventListener('input', ()=>{ descCount.textContent = desc.value.length; });

    // 금액 입력 → 원화 표기
    function setupCurrencyInput(el){
      el.addEventListener("input", ()=>{
        const raw = el.value.replace(/[^0-9]/g,"");
        if(raw){
          el.value = Number(raw).toLocaleString("ko-KR") + "원";
          el.dataset.value = raw;
        } else { el.value = ""; el.dataset.value = ""; }
      });
    }
    setupCurrencyInput(document.getElementById("goalAmount"));
    setupCurrencyInput(document.getElementById("rescuerContribution"));

    // 미리보기 + 삭제 기능
    function setupPreview(inputId, previewId){
      const input = document.getElementById(inputId);
      const preview = document.getElementById(previewId);

      input.addEventListener('change', ()=>{
        preview.innerHTML = '';
        [...input.files].forEach((file,idx)=>{
          const reader = new FileReader();
          reader.onload = e=>{
            const div = document.createElement('div');
            div.innerHTML = `<img src="${e.target.result}" alt="preview"/>`;
            preview.appendChild(div);
          };
          reader.readAsDataURL(file);
        });
      });
    }
    setupPreview('repImage','previewRep');
    setupPreview('situationImages','previewSituation');
    setupPreview('receiptImages','previewReceipt');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      await authReady;

      submitBtn.classList.add('disabled');
      submitBtn.textContent = '업로드 중...';

      try {
        const fd = new FormData(form);
        const projectData = {
          name: fd.get("name"),
          rescuerName: fd.get("rescuerName"),
          summary: fd.get("summary"),
          description: fd.get("description"),
          goalAmount: document.getElementById("goalAmount").dataset.value || 0,
          rescuerContribution: document.getElementById("rescuerContribution").dataset.value || 0,
          registrantKakaoId: fd.get("registrantKakaoId"),
          coverFile: document.getElementById('repImage').files[0] || null,
          galleryFiles: Array.from(document.getElementById('situationImages').files),
          receiptFiles: Array.from(document.getElementById('receiptImages').files)
        };
        const savedId = await apiCreateProject(projectData);
        location.href = 'project.html?id=' + encodeURIComponent(savedId);
      } catch (err) {
        alert('업로드 실패: ' + (err.message || ''));
      } finally {
        submitBtn.classList.remove('disabled');
        submitBtn.textContent = '등록하기';
      }
    });
  </script>
</body>
</html>
