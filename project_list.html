<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>프로젝트 목록</title>
<link rel="stylesheet" href="common.css"/>
<link rel="stylesheet" href="app.min.css"/>
<style>
  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px}
  .card{
    display:flex;flex-direction:column;
    border:1px solid #e5e7eb;border-radius:16px;
    overflow:hidden;background:#fff;
    text-decoration:none;color:inherit;transition:.2s;
  }
  .card:hover{transform:translateY(-3px);box-shadow:0 6px 16px rgba(0,0,0,.1)}
  .card .thumb{position:relative}
  .card .thumb img{width:100%;height:180px;object-fit:cover}
  .card .badge{
    position:absolute;bottom:8px;left:8px;
    background:rgba(0,0,0,0.6);color:#fff;
    padding:4px 8px;border-radius:8px;font-size:.8rem
  }
  .card-body{padding:14px;display:flex;flex-direction:column}
  .card-body h3{margin:0 0 6px;font-size:1.2rem;font-weight:700}
  .card-body .summary{
    margin:0 0 12px;font-size:.95rem;color:#444;
    line-height:1.4;max-height:2.7em;overflow:hidden
  }
  .progress{background:#eee;border-radius:6px;overflow:hidden;height:8px;margin-bottom:8px}
  .progress .bar{background:#A47864;height:100%}
  .stats{display:flex;justify-content:space-between;font-size:.85rem;color:#777;margin-bottom:10px}
  .rescuer{display:flex;align-items:center;gap:6px;font-size:.9rem;font-weight:600;color:#111}
  .rescuer .avatar{font-size:1rem}
  @media(max-width:760px){
    .cards{grid-template-columns:1fr}
    .card img{height:160px}
    .card-body h3{font-size:1.25rem}
    .card-body .summary{font-size:1rem}
  }
</style>
</head>
<body>
  <div data-include="header"></div>

  <main class="container" style="padding:24px 16px">
    <h1 style="margin:0 0 10px">프로젝트</h1>
    <input id="q" placeholder="검색" style="padding:10px;border:1px solid #e5e7eb;border-radius:10px;width:100%;max-width:360px"/>
    <div id="list" class="cards" style="margin-top:14px"></div>
  </main>

  <div data-include="footer"></div>

  <script type="module">
    import { injectLayout } from './js/include.js';
    import { apiListProjects } from './js/api.js';
    import { storage } from './js/firebase.js';
    import { ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

    injectLayout({ active:'list' });

    const $q = document.getElementById('q');
    const $list = document.getElementById('list');
    const fmt = n => Number(n||0).toLocaleString('ko-KR');

    function candidatesOf(p){
      const out = [];
      const push = v => { if (typeof v === 'string' && v.trim()) out.push(v.trim()); };
      ['representativeImageUrl','coverUrl','coverURL','cover','thumbnailUrl','thumbnail','image','mainImageUrl','mainImage','photo','photoUrl']
        .forEach(k => push(p[k]));
      ['galleryUrls','images','photos','pictures','media','attachments','files'].forEach(k => {
        const arr = p[k]; if (Array.isArray(arr)) arr.forEach(it => {
          if (typeof it === 'string') push(it);
          else if (it && (it.url || it.downloadUrl || it.path)) push(it.url || it.downloadUrl || it.path);
        });
      });
      return out;
    }

    async function toHttpUrl(raw){
      if (!raw) return null;
      let v = String(raw).trim();
      if (/^(https?:|data:|blob:)/i.test(v)) return v;
      if (v.startsWith('/')) v = v.slice(1);
      try {
        return await getDownloadURL(ref(storage, v));
      } catch (e) {
        console.warn('getDownloadURL 실패:', v, e?.message || e);
        return null;
      }
    }

    async function coverUrlOf(p){
      for (const c of candidatesOf(p)) {
        const u = await toHttpUrl(c);
        if (u) return u;
      }
      return 'img/placeholder.svg';
    }

    function match(p, q){
      if(!q) return true;
      const hay = [p.name,p.summary,p.description,p.rescuerName].map(x=>(x||'')+'').join(' ').toLowerCase();
      return hay.includes(q.toLowerCase());
    }

    async function render(){
      try{
        const all = await apiListProjects({ status:'all' });
        const q = $q ? $q.value.trim() : '';
        const list = all.filter(p => match(p, q));

        if(!$list) return;
        if(!list.length){ $list.innerHTML = '<div class="muted">결과 없음</div>'; return; }

        const withCovers = await Promise.all(list.map(async p => ({ ...p, _cover: await coverUrlOf(p) })));

        $list.innerHTML = withCovers.map(p => `
          <a class="card" href="project.html?id=${encodeURIComponent(p.id)}">
            <div class="thumb">
              <img src="${p._cover}" alt="cover"/>
              <span class="badge">${p.adminApproved ? '진행중' : '대기중'}</span>
            </div>
            <div class="card-body">
              <h3>${p.name ?? '(이름 없음)'}</h3>
              <p class="summary">${p.summary ?? ''}</p>
              <div class="progress">
                <div class="bar" style="width:${Math.min(100, Math.round((p.currentAmount||0)/p.goalAmount*100))}%"></div>
              </div>
              <div class="stats">
                <span>목표 ${fmt(p.goalAmount)}원</span>
                <span>달성 ${fmt(p.currentAmount||0)}원</span>
                <span>참여 ${p.supporterCount ?? 0}명</span>
              </div>
              <div class="rescuer">
                <span class="avatar">🐾</span>
                <span class="name">${p.rescuerName ?? '익명 구조자'}</span>
              </div>
            </div>
          </a>
        `).join('');
      }catch(e){
        console.error(e);
        if($list) $list.innerHTML = '<div class="muted">프로젝트를 불러오지 못했습니다.</div>';
      }
    }

    if ($q) $q.addEventListener('input', render);
    render();
  </script>
</body>
</html>
