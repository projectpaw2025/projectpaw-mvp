<script type="module">
  import { injectLayout } from './js/include.js';
  import { apiListProjects } from './js/api.js';
  import { storage } from './js/firebase.js';
  import { ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

  injectLayout({ active:'list' });

  const $q = document.getElementById('q');
  const $list = document.getElementById('list');

  // ---------- 이미지 후보/변환(강화판) ----------
  const pick = (...cands) => cands.find(u => typeof u === 'string' && u.trim());

  function candidatesOf(p){
    const out = [];
    const push = v => { if (typeof v === 'string' && v.trim()) out.push(v.trim()); };
    const simple = [
      'representativeImageUrl','coverUrl','coverURL','cover',
      'thumbnailUrl','thumbnail','image','mainImageUrl','mainImage',
      'photo','photoUrl'
    ];
    simple.forEach(k => push(p[k]));

    const arrays = ['galleryUrls','images','photos','pictures','media','attachments','files'];
    arrays.forEach(k => {
      const arr = p[k];
      if (Array.isArray(arr)) {
        arr.forEach(it => {
          if (typeof it === 'string') push(it);
          else if (it && (it.url || it.downloadUrl || it.path)) push(it.url || it.downloadUrl || it.path);
        });
      }
    });
    return out;
  }

  async function toHttpUrl(maybe) {
    if (!maybe) return null;
    if (typeof maybe === 'string') maybe = maybe.trim();
    // 이미 표시 가능한 스킴
    if (/^(https?:|data:|blob:)/i.test(maybe)) return maybe;
    // 선행 슬래시 제거 (/covers/.. → covers/..)
    if (maybe.startsWith('/')) maybe = maybe.slice(1);
    // 잘못 저장된 gs 버킷 교정 (*.firebasestorage.app → *.appspot.com)
    if (/^gs:\/\//i.test(maybe)) {
      maybe = maybe.replace(/gs:\/\/([^/]+)\.firebasestorage\.app(\/|$)/i, 'gs://$1.appspot.com$2');
    }
    try {
      const r = ref(storage, maybe);     // 'covers/...' 또는 교정된 'gs://...'
      return await getDownloadURL(r);
    } catch (e) {
      console.warn('getDownloadURL 실패:', maybe, e?.message || e);
      return null;
    }
  }

  async function coverUrlOf(p) {
    const cands = candidatesOf(p);
    for (const c of cands) {
      const u = await toHttpUrl(c);
      if (u) return u;
    }
    return 'img/placeholder.svg';
  }
  // ---------- /이미지 보강 끝 ----------

  function match(p, q){
    if(!q) return true;
    const hay = [p.name, p.summary, p.description, p.rescuerName]
      .map(x => (x||'')+'').join(' ').toLowerCase();
    return hay.includes(q.toLowerCase());
  }

  const fmt = n => Number(n||0).toLocaleString('ko-KR');

  async function render(){
    try{
      // 승인 전 포함
      const all = await apiListProjects({ status:'all' });
      const list = all.filter(p => match(p, $q.value.trim()));

      if(!list.length){
        $list.innerHTML = '<div class="muted">결과 없음</div>';
        return;
      }

      // 각 항목 커버 URL 해석
      const withCovers = await Promise.all(list.map(async p => ({
        ...p,
        _cover: await coverUrlOf(p)
      })));

      $list.innerHTML = withCovers.map(p => `
        <article class="card">
          <img src="${p._cover}" alt="cover"/>
          <div class="card-body">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
              <strong>${p.name ?? '(이름 없음)'}</strong>
              ${p.adminApproved ? '<span class="chip approved">승인</span>' : '<span class="chip pending">대기</span>'}
            </div>
            <div class="muted">${p.summary ?? ''}</div>
            <div class="muted">목표 ${fmt(p.goalAmount)} · 부담 ${fmt(p.rescuerContribution)}</div>
            <div style="text-align:right">
              <a class="btn primary" style="padding:8px 12px;border-radius:10px" href="project.html?id=${encodeURIComponent(p.id)}">상세보기</a>
            </div>
          </div>
        </article>
      `).join('');
    }catch(e){
      console.error(e);
      $list.innerHTML = '<div class="muted">프로젝트를 불러오지 못했습니다.</div>';
    }
  }

  $q.addEventListener('input', render);
  render();
</script>
