<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í›„ì›í•˜ê¸° â€” Project.PAW</title>

  <!-- ë””ìì¸ì€ ê¸°ì¡´ CSSë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì„¸ìš” -->
  <link rel="stylesheet" href="css/common.css" />
  <link rel="stylesheet" href="css/list.css" />
</head>
<body>
  <header class="topbar">
    <div class="container">
      <a class="brand" href="index.html">Project.PAW</a>
      <nav class="nav">
        <a href="index.html" class="btn ghost">í™ˆ</a>
        <a href="create.html" class="btn primary">ë“±ë¡í•˜ê¸°</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <div class="row between center">
        <h1 class="section-title">ëª¨ë“  í”„ë¡œì íŠ¸</h1>
        <div class="controls row gap-12">
          <label class="row gap-6 center">
            <input id="onlyApproved" type="checkbox" />
            ìŠ¹ì¸ë§Œ ë³´ê¸°
          </label>
          <select id="sort">
            <option value="latest">ìµœì‹ ìˆœ</option>
            <option value="progress">ë‹¬ì„±ë¥ ìˆœ</option>
            <option value="goal">ëª©í‘œê¸ˆì•¡ ë†’ì€ìˆœ</option>
          </select>
        </div>
      </div>

      <div id="list" class="grid list-grid" style="margin-top: 16px;"></div>
    </section>
  </main>

  <footer class="container muted" style="padding:40px 0;">
    Â© Project.PAW
  </footer>

  <!-- âœ… ë°±ì—”ë“œ/ìŠ¤í† ë¦¬ì§€ ëª¨ë“ˆ -->
  <script type="module">
    import "./js/firebase.js";                          // Firebase ì´ˆê¸°í™” (ìµëª… ë¡œê·¸ì¸ì€ firebase.jsì—ì„œ ì²˜ë¦¬)
    import { storage, fmt } from "./js/app.js";
    import { percent, esc } from "./js/utils.js";

    const wrap = document.querySelector("#list");
    const sortSel = document.querySelector("#sort");
    const onlyApproved = document.querySelector("#onlyApproved");

    const skeletons = () => {
      wrap.innerHTML = Array.from({ length: 6 })
        .map(() => `<a class="card row skeleton" href="javascript:void(0)"></a>`).join("");
    };

    async function render() {
      skeletons();

      let items = await storage.getAll();  // ğŸ”¥ Firestoreì—ì„œ ì§ì ‘ ë¡œë“œ

      // ìŠ¹ì¸ë§Œ ë³´ê¸°
      if (onlyApproved?.checked) {
        items = items.filter(p => (p.status || "pending") === "approved");
      }

      // ì •ë ¬
      const mode = sortSel?.value || "latest";
      if (mode === "latest") {
        // serverTimestampëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìˆ«ìê°€ ì•„ë‹ˆë¯€ë¡œ, createdAt?.seconds ê¸°ì¤€ ì •ë ¬
        items.sort((a, b) => {
          const ax = a.createdAt?.seconds || 0;
          const bx = b.createdAt?.seconds || 0;
          return bx - ax;
        });
      } else if (mode === "progress") {
        items.sort((a, b) => {
          const pa = percent(a.raisedAmount || 0, a.targetAmount || 0);
          const pb = percent(b.raisedAmount || 0, b.targetAmount || 0);
          return pb - pa;
        });
      } else if (mode === "goal") {
        items.sort((a, b) => Number(b.targetAmount || 0) - Number(a.targetAmount || 0));
      }

      // ë Œë”
      wrap.innerHTML = (items.length ? items : []).map(p => {
        const badge = (p.status === "approved")
          ? '<span class="badge approved">ìŠ¹ì¸</span>'
          : '<span class="badge pending">ëŒ€ê¸°</span>';

        const pct = percent(p.raisedAmount || 0, p.targetAmount || 1);
        const cover = (p.images && p.images.cover) ? p.images.cover : "img/placeholder.svg";

        return `
          <a class="card row" href="project.html?id=${encodeURIComponent(p.id)}" aria-label="í”„ë¡œì íŠ¸ ${esc(p.title || '')} ìƒì„¸ ë³´ê¸°">
            <img class="thumb" src="${cover}" alt="ëŒ€í‘œ ì´ë¯¸ì§€" />
            <div class="info">
              <div class="row between center">
                <h3 class="title">${esc(p.title || '')}</h3>
                ${badge}
              </div>
              <p class="summary">${esc(p.summary || '')}</p>
              <div class="progress">
                <i style="width:${pct}%"></i>
              </div>
              <div class="row gap-12 muted">
                <span>ëª©í‘œ ${fmt(p.targetAmount)}ì›</span>
                <span>êµ¬ì¡°ì ${fmt(p.selfPayAmount)}ì›</span>
              </div>
            </div>
          </a>
        `;
      }).join("");

      if (!items.length) {
        wrap.innerHTML = `<div class="empty">í‘œì‹œí•  í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      }
    }

    sortSel?.addEventListener("change", render);
    onlyApproved?.addEventListener("change", render);

    render();
  </script>
</body>
</html>
