// assets/js/admin.js
import { fetchAllProjects, approveProject } from "./api.js";

const pw = document.getElementById("pw");
const loginBtn = document.getElementById("login");
const ui = document.getElementById("admin-ui");
const pending = document.getElementById("pending");
const approved = document.getElementById("approved");

loginBtn.addEventListener("click", async () => {
  if ((pw.value || "").trim() !== "paw2025") {
    alert("비밀번호가 올바르지 않습니다.");
    return;
  }
  ui.style.display = "block";
  render();
});

async function render() {
  const arr = await fetchAllProjects();
  const pend = arr.filter((p) => !p.adminApproved);
  const ok = arr.filter((p) => p.adminApproved);

  pending.innerHTML =
    pend
      .map(
        (p) => `<div class="card">
          <img src="${p.coverUrl || "assets/img/paw.svg"}"/>
          <div class="content">
            <strong>${p.name}</strong>
            <div class="meta">목표 ₩${(p.goalAmount || 0).toLocaleString("ko-KR")}</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
              <button class="btn-primary" data-approve="${p.id}">승인</button>
              <a class="btn-outline" href="project.html?id=${p.id}" target="_blank">보기</a>
            </div>
          </div>
        </div>`
      )
      .join("") || '<div class="empty">대기중 항목 없음</div>';

  approved.innerHTML =
    ok
      .map(
        (p) => `<div class="card">
          <img src="${p.coverUrl || "assets/img/paw.svg"}"/>
          <div class="content">
            <strong>${p.name}</strong>
            <div class="meta">목표 ₩${(p.goalAmount || 0).toLocaleString("ko-KR")}</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
              <span class="badge">승인됨</span>
              <a class="btn-outline" href="project.html?id=${p.id}" target="_blank">보기</a>
            </div>
          </div>
        </div>`
      )
      .join("") || '<div class="empty">승인 항목 없음</div>';

  pending.querySelectorAll("[data-approve]").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const id = btn.getAttribute("data-approve");
      await approveProject(id, true);
      render();
    });
  });
}
