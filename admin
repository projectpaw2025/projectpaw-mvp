<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin — Project.PAW</title>
  <style>
    :root{--primary:#1f6feb;--muted:#6b7280;--bg:#0a0f1d;--card:#0f1629;--line:#1a2342;--radius:14px}
    *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:#e5e7eb;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    a{text-decoration:none;color:inherit}
    .container{max-width:1100px;margin:0 auto;padding:0 16px}
    header{position:sticky;top:0;background:#0b1222;border-bottom:1px solid var(--line)}
    header .inner{display:flex;justify-content:space-between;align-items:center;padding:14px 0}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.ghost{background:#ffffff12}
    .grid{display:grid;grid-template-columns:.8fr 1.2fr;gap:16px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:14px}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0c1326;color:#e5e7eb}
    label{font-size:13px;color:#9aa8c7;font-weight:700}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);font-size:14px}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px}
    .badge.approved{background:#09291a;color:#4ae39b;border:1px solid #153a27}
    .badge.pending{background:#2a1e05;color:#ffcc6b;border:1px solid #3e2b08}
    .muted{color:#9aa8c7}
  </style>
</head>
<body>
  <header>
    <div class="container inner">
      <strong>Project.PAW Admin</strong>
      <nav>
        <a class="btn ghost" href="index.html">사이트 보기</a>
      </nav>
    </div>
  </header>

  <main class="container" style="padding:18px 0 28px">
    <div class="grid">
      <!-- 좌: 단건 편집 -->
      <section class="card">
        <h3 style="margin:4px 0 12px 0">프로젝트 승인/수정</h3>
        <div style="display:grid;gap:10px">
          <div>
            <label>관리자 암호</label>
            <input id="adminPass" type="password" placeholder="운영용 임시 암호"/>
          </div>
          <div>
            <label>프로젝트 ID</label>
            <input id="pid" type="text" placeholder="project id (URL의 ?id=... 값)"/>
          </div>
          <div>
            <label>상태</label>
            <select id="status">
              <option value="pending">대기</option>
              <option value="approved">승인</option>
            </select>
          </div>
          <div>
            <label>카카오 오픈채팅 링크</label>
            <input id="kakao" type="url" placeholder="https://open.kakao.com/o/xxxxxx"/>
          </div>
          <div>
            <button id="loadBtn" class="btn ghost" type="button">불러오기</button>
            <button id="saveBtn" class="btn primary" type="button">저장</button>
          </div>
          <p class="muted" id="msg"></p>
        </div>
      </section>

      <!-- 우: 대기 목록 -->
      <section class="card">
        <h3 style="margin:4px 0 12px 0">심사 대기 목록</h3>
        <table>
          <thead><tr><th>ID</th><th>제목</th><th>등록일</th><th>상태</th></tr></thead>
          <tbody id="pending"></tbody>
        </table>
      </section>
    </div>
  </main>

  <script type="module">
    import "./js/firebase.js";
    import { storage } from "./js/app.js";

    // ⚠️ 임시 운영 암호 — 실제 운영에서는 Firebase Auth(구글 로그인)으로 대체
    const ADMIN_PASS = "CHANGE_ME";

    const $ = (s, r=document)=>r.querySelector(s);
    const pid = $("#pid"), status = $("#status"), kakao = $("#kakao");
    const msg = $("#msg"), pass = $("#adminPass");

    function ok(t){ msg.textContent = t; msg.style.color = "#a7f3d0"; }
    function err(t){ msg.textContent = t; msg.style.color = "#fecaca"; }

    async function refreshPending(){
      const all = await storage.getAll();
      const pend = all.filter(p=> (p.status||"pending")==="pending");
      $("#pending").innerHTML = pend.map(p=>{
        const sec = p.createdAt?.seconds ? new Date(p.createdAt.seconds*1000).toLocaleString("ko-KR") : "-";
        return `<tr>
          <td style="font-family:ui-monospace">${p.id}</td>
          <td>${(p.title||"")}</td>
          <td class="muted">${sec}</td>
          <td><span class="badge pending">대기</span></td>
        </tr>`;
      }).join("") || `<tr><td colspan="4" class="muted">대기 중인 프로젝트가 없습니다.</td></tr>`;
    }

    $("#loadBtn").onclick = async ()=>{
      try{
        if(!pid.value) return err("프로젝트 ID를 입력하세요");
        const p = await storage.byId(pid.value);
        if(!p) return err("해당 ID의 프로젝트가 없습니다");
        status.value = (p.status||"pending");
        kakao.value = (p.kakaoLink||"");
        ok("불러왔습니다.");
      }catch(e){ err("불러오기 실패: "+e.message); }
    };

    $("#saveBtn").onclick = async ()=>{
      try{
        if(pass.value !== ADMIN_PASS) return err("관리자 암호가 올바르지 않습니다");
        if(!pid.value) return err("프로젝트 ID를 입력하세요");
        // 간단 검증
        const link = kakao.value.trim();
        if(link && !/^https?:\/\/open\.kakao\.com\//.test(link)) return err("카카오 오픈채팅 링크 형식을 확인하세요");
        const p = await storage.byId(pid.value);
        if(!p) return err("해당 ID의 프로젝트가 없습니다");
        // 업데이트: app.js에 update 메서드가 없다면, add로 upsert하는 대신 Firestore SDK 직접 사용 권장
        // 여기서는 간단히 add처럼 병합 저장 로직을 storage에 위임했다고 가정
        const updated = { ...p, status: status.value, kakaoLink: link };
        // 임시: storage.add가 upsert라면 그대로 사용, 아니라면 app.js에 update(id,partial) 추가 권장
        const saved = await storage.add(updated);
        ok("저장 완료");
        refreshPending();
      }catch(e){ err("저장 실패: "+e.message); }
    };

    refreshPending();
  </script>
</body>
</html>
